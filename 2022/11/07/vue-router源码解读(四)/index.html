<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhanghang12135.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="分析vue-router 的每一行代码 – createRouter">
<meta property="og:type" content="article">
<meta property="og:title" content="vue-router源码解读(四)">
<meta property="og:url" content="https://zhanghang12135.github.io/2022/11/07/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E5%9B%9B)/index.html">
<meta property="og:site_name" content="H.S.">
<meta property="og:description" content="分析vue-router 的每一行代码 – createRouter">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zhanghang12135.github.io/2022/11/07/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E5%9B%9B)/cover.jpg">
<meta property="article:published_time" content="2022-11-07T14:42:13.000Z">
<meta property="article:modified_time" content="2022-11-20T08:25:41.636Z">
<meta property="article:author" content="灰沙">
<meta property="article:tag" content="vue-router">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhanghang12135.github.io/2022/11/07/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E5%9B%9B)/cover.jpg">


<link rel="canonical" href="https://zhanghang12135.github.io/2022/11/07/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E5%9B%9B)/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zhanghang12135.github.io/2022/11/07/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E5%9B%9B)/","path":"2022/11/07/vue-router源码解读(四)/","title":"vue-router源码解读(四)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>vue-router源码解读(四) | H.S.</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">H.S.</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">成功的人抄袭，伟大的人剽窃</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#createRouter"><span class="nav-number">1.</span> <span class="nav-text">createRouter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#parseQuery-originalParseQuery"><span class="nav-number">1.1.</span> <span class="nav-text">parseQuery (originalParseQuery)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stringifyQuery"><span class="nav-number">1.2.</span> <span class="nav-text">stringifyQuery</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useCallbacks"><span class="nav-number">1.3.</span> <span class="nav-text">useCallbacks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Matcher-%E5%8C%B9%E9%85%8D%E5%99%A8%E7%9B%B8%E5%85%B3"><span class="nav-number">2.</span> <span class="nav-text">Matcher 匹配器相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#addRoute"><span class="nav-number">2.1.</span> <span class="nav-text">addRoute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#removeRoute"><span class="nav-number">2.2.</span> <span class="nav-text">removeRoute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hasRoute"><span class="nav-number">2.3.</span> <span class="nav-text">hasRoute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getRoutes"><span class="nav-number">2.4.</span> <span class="nav-text">getRoutes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#resolve"><span class="nav-number">2.5.</span> <span class="nav-text">resolve</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#History-%E7%9B%B8%E5%85%B3"><span class="nav-number">3.</span> <span class="nav-text">History 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#push"><span class="nav-number">3.1.</span> <span class="nav-text">push</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pushWithRedirect"><span class="nav-number">3.1.1.</span> <span class="nav-text">pushWithRedirect</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handleRedirectRecord"><span class="nav-number">3.1.2.</span> <span class="nav-text">handleRedirectRecord</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#navigate"><span class="nav-number">3.1.3.</span> <span class="nav-text">navigate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#extractChangingRecords"><span class="nav-number">3.1.4.</span> <span class="nav-text">extractChangingRecords</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#runGuardQueue"><span class="nav-number">3.1.5.</span> <span class="nav-text">runGuardQueue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#replace"><span class="nav-number">3.2.</span> <span class="nav-text">replace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#go"><span class="nav-number">3.3.</span> <span class="nav-text">go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#back"><span class="nav-number">3.4.</span> <span class="nav-text">back</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forward"><span class="nav-number">3.5.</span> <span class="nav-text">forward</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%AF%BC%E8%88%AA%E5%AE%88%E5%8D%AB"><span class="nav-number">4.</span> <span class="nav-text">全局导航守卫</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#beforeEach-amp-beforeResolve-amp-afterEach"><span class="nav-number">4.1.</span> <span class="nav-text">beforeEach &amp; beforeResolve &amp; afterEach</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E5%AE%83"><span class="nav-number">5.</span> <span class="nav-text">其它</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#onError"><span class="nav-number">5.1.</span> <span class="nav-text">onError</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isReady"><span class="nav-number">5.2.</span> <span class="nav-text">isReady</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">6.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#install"><span class="nav-number">6.1.</span> <span class="nav-text">install</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="灰沙"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">灰沙</p>
  <div class="site-description" itemprop="description">前端个人博客</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
      <span style="margin: 10px 0; font-size:14px">更多文章，微信扫描二维码</span>
      <img src='https://open.weixin.qq.com/qr/code?username=FanRenWeb' width="150px" height="150px"/>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhanghang12135.github.io/2022/11/07/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E5%9B%9B)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="灰沙">
      <meta itemprop="description" content="前端个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="H.S.">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          vue-router源码解读(四)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-07 22:42:13" itemprop="dateCreated datePublished" datetime="2022-11-07T22:42:13+08:00">2022-11-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-20 16:25:41" itemprop="dateModified" datetime="2022-11-20T16:25:41+08:00">2022-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <html><head></head><body><div style="width:100%"><img style="width:80%;height:400px" src="/2022/11/07/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E5%9B%9B)/cover.jpg"></div>

<p><strong>分析vue-router 的每一行代码 – createRouter</strong></p>
<span id="more"></span>
<h2 id="createRouter"><a href="#createRouter" class="headerlink" title="createRouter"></a>createRouter</h2><p>返回router实例，里面包含了很多方法</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouter</span>(<span class="params">options: RouterOptions</span>): <span class="title">Router</span> </span>{</span><br><span class="line">  <span class="comment">// 返回一个对象，包含addRoute, getRouteMatcher, resolve, romveRoute,getRoutes </span></span><br><span class="line">  <span class="comment">// 里面有matchers 闭包对象，就是所有路由的匹配器</span></span><br><span class="line">  <span class="keyword">const</span> matcher = createRouterMatcher(options.routes, options)</span><br><span class="line">  <span class="comment">// 用于解析查询的自定义实现。必须解码查询键和值。 https://router.vuejs.org/zh/api/#parsequery</span></span><br><span class="line">  <span class="comment">// originalParseQuery 是默认提供的解析函数</span></span><br><span class="line">  <span class="keyword">const</span> parseQuery = options.parseQuery || originalParseQuery</span><br><span class="line">  <span class="comment">// 对查询对象进行字符串化的自定义实现。 https://router.vuejs.org/zh/api/#stringifyquery</span></span><br><span class="line">  <span class="keyword">const</span> stringifyQuery = options.stringifyQuery || originalStringifyQuery</span><br><span class="line">  <span class="comment">// 前面创建的History 对象</span></span><br><span class="line">  <span class="keyword">const</span> routerHistory = options.history</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !routerHistory)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">'Provide the "history" option when calling "createRouter()":'</span> +</span><br><span class="line">        <span class="string">' https://next.router.vuejs.org/api/#history.'</span></span><br><span class="line">    )</span><br><span class="line">  <span class="comment">// 全局前置守卫对象 { add, list, reset }</span></span><br><span class="line">  <span class="keyword">const</span> beforeGuards = useCallbacks&lt;NavigationGuardWithThis&lt;<span class="literal">undefined</span>&gt;&gt;()</span><br><span class="line">  <span class="comment">// 全局解析守卫对象</span></span><br><span class="line">  <span class="keyword">const</span> beforeResolveGuards = useCallbacks&lt;NavigationGuardWithThis&lt;<span class="literal">undefined</span>&gt;&gt;()</span><br><span class="line">  <span class="comment">// 全局后置守卫对象</span></span><br><span class="line">  <span class="keyword">const</span> afterGuards = useCallbacks&lt;NavigationHookAfter&gt;()</span><br><span class="line">  <span class="comment">// 当前路由对象， shallowRef 是浅层的响应性转变 https://cn.vuejs.org/api/reactivity-advanced.html#shallowref</span></span><br><span class="line">  <span class="comment">// 可以理解为 只有重新赋值currentRoute.value 会触发响应</span></span><br><span class="line">  <span class="keyword">const</span> currentRoute = shallowRef&lt;RouteLocationNormalizedLoaded&gt;(</span><br><span class="line">    START_LOCATION_NORMALIZED</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 正在等待的loaction</span></span><br><span class="line">  <span class="keyword">let</span> pendingLocation: RouteLocation = START_LOCATION_NORMALIZED</span><br><span class="line"></span><br><span class="line">  <span class="comment">// leave the scrollRestoration if no scrollBehavior is provided</span></span><br><span class="line">  <span class="comment">// 如果没有提供scrollBehavior， 那么就不用设置 scrollRestoration</span></span><br><span class="line">  <span class="comment">// history 是 window.history , scrollRestoration 是滚动恢复行为， 默认是 auto（默认值的说法chrome 的开发文档上找到的 https://developer.chrome.com/blog/history-api-scroll-restoration/） MDN上的解析：https://developer.mozilla.org/zh-CN/docs/Web/API/History/scrollRestoration</span></span><br><span class="line">  <span class="comment">// 注意 history 是和 tab 标签页绑定的，和文档没关系</span></span><br><span class="line">  <span class="keyword">if</span> (isBrowser &amp;&amp; options.scrollBehavior &amp;&amp; <span class="string">'scrollRestoration'</span> <span class="keyword">in</span> history) {</span><br><span class="line">    history.scrollRestoration = <span class="string">'manual'</span> </span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 规范params的函数 ， 转变为string</span></span><br><span class="line">  <span class="keyword">const</span> normalizeParams = applyToParams.bind(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="function"><span class="params">paramValue</span> =&gt;</span> <span class="string">''</span> + paramValue</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 加密params</span></span><br><span class="line">  <span class="keyword">const</span> encodeParams = applyToParams.bind(<span class="literal">null</span>, encodeParam)</span><br><span class="line">  <span class="comment">// 解密params</span></span><br><span class="line">  <span class="keyword">const</span> decodeParams: <span class="function">(<span class="params">params: RouteParams | <span class="literal">undefined</span></span>) =&gt;</span> RouteParams =</span><br><span class="line">    <span class="comment">// @ts-expect-error: intentionally avoid the type check</span></span><br><span class="line">    applyToParams.bind(<span class="literal">null</span>, decode)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... 很多方法， 后续再仔细解读</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 移除history的监听器</span></span><br><span class="line">  <span class="keyword">let</span> removeHistoryListener: <span class="literal">undefined</span> | <span class="literal">null</span> | (<span class="function">() =&gt;</span> <span class="built_in">void</span>)</span><br><span class="line">  <span class="comment">// Initialization and Errors</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ready 回调</span></span><br><span class="line">  <span class="keyword">let</span> readyHandlers = useCallbacks&lt;OnReadyCallback&gt;()</span><br><span class="line">  <span class="comment">// 异常回调</span></span><br><span class="line">  <span class="keyword">let</span> errorHandlers = useCallbacks&lt;_ErrorHandler&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ready: <span class="built_in">boolean</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... 这里也有一些方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// router的Api go</span></span><br><span class="line">  <span class="comment">// https://router.vuejs.org/zh/api/#go</span></span><br><span class="line">  <span class="comment">// 第一篇里面说过，就是的 History.go</span></span><br><span class="line">  <span class="keyword">const</span> go = <span class="function">(<span class="params">delta: <span class="built_in">number</span></span>) =&gt;</span> routerHistory.go(delta)</span><br><span class="line">  <span class="comment">// 第一次进入的标记</span></span><br><span class="line">  <span class="keyword">let</span> started: <span class="built_in">boolean</span> | <span class="literal">undefined</span></span><br><span class="line">  <span class="comment">// 已经安装的vue App 集合</span></span><br><span class="line">  <span class="keyword">const</span> installedApps = <span class="keyword">new</span> <span class="built_in">Set</span>&lt;App&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> router: Router = {</span><br><span class="line">    <span class="comment">// 当前的路由对象， vue3中这是一个Ref</span></span><br><span class="line">    currentRoute,</span><br><span class="line">    <span class="comment">// 允许关闭 history 事件的监听。 这是用于微前端的低级api</span></span><br><span class="line">    <span class="attr">listening</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 添加路由</span></span><br><span class="line">    addRoute,</span><br><span class="line">    <span class="comment">// 移除路由</span></span><br><span class="line">    removeRoute,</span><br><span class="line">    hasRoute,</span><br><span class="line">    getRoutes,</span><br><span class="line">    resolve,</span><br><span class="line">    options,</span><br><span class="line"></span><br><span class="line">    push,</span><br><span class="line">    replace,</span><br><span class="line">    go,</span><br><span class="line">    <span class="attr">back</span>: <span class="function">() =&gt;</span> go(-<span class="number">1</span>),</span><br><span class="line">    <span class="attr">forward</span>: <span class="function">() =&gt;</span> go(<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">    <span class="attr">beforeEach</span>: beforeGuards.add,</span><br><span class="line">    <span class="attr">beforeResolve</span>: beforeResolveGuards.add,</span><br><span class="line">    <span class="attr">afterEach</span>: afterGuards.add,</span><br><span class="line"></span><br><span class="line">    <span class="attr">onError</span>: errorHandlers.add,</span><br><span class="line">    isReady,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">install</span>(<span class="params">app: App</span>)</span> {</span><br><span class="line">      <span class="comment">// vue 的安装方法</span></span><br><span class="line">    },</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> router</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="parseQuery-originalParseQuery"><a href="#parseQuery-originalParseQuery" class="headerlink" title="parseQuery (originalParseQuery)"></a>parseQuery (originalParseQuery)</h3><p>就是将?a=b =&gt; {a:b}</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Transforms a queryString into a {<span class="doctag">@link </span>LocationQuery} object. Accept both, a</span></span><br><span class="line"><span class="comment"> * version with the leading `?` and without Should work as URLSearchParams</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">search</span></span> - search string to parse</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns </span>a query object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseQuery</span>(<span class="params">search: <span class="built_in">string</span></span>): <span class="title">LocationQuery</span> </span>{</span><br><span class="line">  <span class="keyword">const</span> query: LocationQuery = {}</span><br><span class="line">  <span class="comment">// avoid creating an object with an empty key and empty value</span></span><br><span class="line">  <span class="comment">// because of split('&amp;')</span></span><br><span class="line">  <span class="keyword">if</span> (search === <span class="string">''</span> || search === <span class="string">'?'</span>) <span class="keyword">return</span> query</span><br><span class="line">  <span class="keyword">const</span> hasLeadingIM = search[<span class="number">0</span>] === <span class="string">'?'</span></span><br><span class="line">  <span class="comment">// 去除? ,根据 &amp; 拆分成 数组</span></span><br><span class="line">  <span class="keyword">const</span> searchParams = (hasLeadingIM ? search.slice(<span class="number">1</span>) : search).split(<span class="string">'&amp;'</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; searchParams.length; ++i) {</span><br><span class="line">    <span class="comment">// pre decode the + into space</span></span><br><span class="line">    <span class="keyword">const</span> searchParam = searchParams[i].replace(PLUS_RE, <span class="string">' '</span>)</span><br><span class="line">    <span class="comment">// allow the = character</span></span><br><span class="line">    <span class="keyword">const</span> eqPos = searchParam.indexOf(<span class="string">'='</span>)</span><br><span class="line">    <span class="keyword">const</span> key = decode(eqPos &lt; <span class="number">0</span> ? searchParam : searchParam.slice(<span class="number">0</span>, eqPos))</span><br><span class="line">    <span class="keyword">const</span> value = eqPos &lt; <span class="number">0</span> ? <span class="literal">null</span> : decode(searchParam.slice(eqPos + <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key <span class="keyword">in</span> query) {</span><br><span class="line">      <span class="comment">// an extra variable for ts types</span></span><br><span class="line">      <span class="keyword">let</span> currentValue = query[key]</span><br><span class="line">      <span class="keyword">if</span> (!isArray(currentValue)) {</span><br><span class="line">        currentValue = query[key] = [currentValue]</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// we force the modification</span></span><br><span class="line">      ;(currentValue <span class="keyword">as</span> LocationQueryValue[]).push(value)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      query[key] = value</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> query</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="stringifyQuery"><a href="#stringifyQuery" class="headerlink" title="stringifyQuery"></a>stringifyQuery</h3><p>query 对象字符串化</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Stringifies a {<span class="doctag">@link </span>LocationQueryRaw} object. Like `URLSearchParams`, it</span></span><br><span class="line"><span class="comment"> * doesn't prepend a `?`</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">query</span></span> - query object to stringify</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns </span>string version of the query without the leading `?`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">stringifyQuery</span>(<span class="params">query: LocationQueryRaw</span>): <span class="title">string</span> </span>{</span><br><span class="line">  <span class="keyword">let</span> search = <span class="string">''</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> query) {</span><br><span class="line">    <span class="keyword">const</span> value = query[key]</span><br><span class="line">    key = encodeQueryKey(key)</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) {</span><br><span class="line">      <span class="comment">// only null adds the value</span></span><br><span class="line">      <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) {</span><br><span class="line">        search += (search.length ? <span class="string">'&amp;'</span> : <span class="string">''</span>) + key</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// keep null values</span></span><br><span class="line">    <span class="keyword">const</span> values: LocationQueryValueRaw[] = isArray(value)</span><br><span class="line">      ? value.map(<span class="function"><span class="params">v</span> =&gt;</span> v &amp;&amp; encodeQueryValue(v))</span><br><span class="line">      : [value &amp;&amp; encodeQueryValue(value)]</span><br><span class="line"></span><br><span class="line">    values.forEach(<span class="function"><span class="params">value</span> =&gt;</span> {</span><br><span class="line">      <span class="comment">// skip undefined values in arrays as if they were not present</span></span><br><span class="line">      <span class="comment">// smaller code than using filter</span></span><br><span class="line">      <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) {</span><br><span class="line">        <span class="comment">// only append &amp; with non-empty search</span></span><br><span class="line">        search += (search.length ? <span class="string">'&amp;'</span> : <span class="string">''</span>) + key</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span>) search += <span class="string">'='</span> + value</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> search</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="useCallbacks"><a href="#useCallbacks" class="headerlink" title="useCallbacks"></a>useCallbacks</h3><p>回调函数的hook,<br>被用来创建before导航守卫， after导航守卫</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a list of callbacks that can be reset. Used to create before and after navigation guards list</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useCallbacks</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> handlers: T[] = []</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">handler: T</span>): (<span class="params"></span>) =&gt; <span class="title">void</span> </span>{</span><br><span class="line">    handlers.push(handler)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">const</span> i = handlers.indexOf(handler)</span><br><span class="line">      <span class="keyword">if</span> (i &gt; -<span class="number">1</span>) handlers.splice(i, <span class="number">1</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reset</span>(<span class="params"></span>) </span>{</span><br><span class="line">    handlers = []</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    add,</span><br><span class="line">    <span class="attr">list</span>: <span class="function">() =&gt;</span> handlers,</span><br><span class="line">    reset,</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>下面的是router 所暴露的api</p>
<h2 id="Matcher-匹配器相关"><a href="#Matcher-匹配器相关" class="headerlink" title="Matcher 匹配器相关"></a>Matcher 匹配器相关</h2><h3 id="addRoute"><a href="#addRoute" class="headerlink" title="addRoute"></a>addRoute</h3><p>添加路由到队列中，有两种函数声明。给某个路由添加子路由或者给全局添加路由<br><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#addroute">官方文档 addRoute</a></p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Add a new {<span class="doctag">@link </span>RouteRecordRaw | route record} as the child of an existing route.</span></span><br><span class="line"><span class="comment">   * 给某个路由添加子路由</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">parentName</span></span> - Parent Route Record where `route` should be appended at</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">route</span></span> - Route Record to add</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addRoute(parentName: RouteRecordName, <span class="attr">route</span>: RouteRecordRaw): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Add a new {<span class="doctag">@link </span>RouteRecordRaw | route record} to the router.</span></span><br><span class="line"><span class="comment">   * 添加新路由</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">route</span></span> - Route Record to add</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addRoute(route: RouteRecordRaw): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  parentOrRoute: RouteRecordName | RouteRecordRaw,</span></span></span><br><span class="line"><span class="params"><span class="function">  route?: RouteRecordRaw</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>{</span><br><span class="line">  <span class="comment">// Parameters 是拿到函数类型里面的参数类型</span></span><br><span class="line">  <span class="comment">// 这里就是 RouteRecordMatcher 就是路由的匹配器对象</span></span><br><span class="line">  <span class="keyword">let</span> parent: Parameters&lt;<span class="keyword">typeof</span> matcher[<span class="string">'addRoute'</span>]&gt;[<span class="number">1</span>] | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">let</span> record: RouteRecordRaw</span><br><span class="line">  <span class="comment">// parentOrRoute 存在</span></span><br><span class="line">  <span class="keyword">if</span> (isRouteName(parentOrRoute)) {</span><br><span class="line">    parent = matcher.getRecordMatcher(parentOrRoute)</span><br><span class="line">    record = route!</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    record = parentOrRoute</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 直接调用 匹配器的 addRoute 添加matcher</span></span><br><span class="line">  <span class="keyword">return</span> matcher.addRoute(record, parent)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="removeRoute"><a href="#removeRoute" class="headerlink" title="removeRoute"></a>removeRoute</h3><p>通过名称删除现有路由。<br><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#removeroute">官方文档 removeRoute</a></p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeRoute</span>(<span class="params">name: RouteRecordName</span>) </span>{</span><br><span class="line">  <span class="comment">// 找到目标路由匹配器</span></span><br><span class="line">  <span class="keyword">const</span> recordMatcher = matcher.getRecordMatcher(name)</span><br><span class="line">  <span class="keyword">if</span> (recordMatcher) {</span><br><span class="line">    <span class="comment">// 删除路由</span></span><br><span class="line">    matcher.removeRoute(recordMatcher)</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) {</span><br><span class="line">    warn(<span class="string">`Cannot remove non-existent route "<span class="subst">${<span class="built_in">String</span>(name)}</span>"`</span>)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="hasRoute"><a href="#hasRoute" class="headerlink" title="hasRoute"></a>hasRoute</h3><p>检查路由是否存在<br><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#hasroute">官方文档 hasRoute</a></p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks if a route with a given name exists</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">name</span></span> - Name of the route to check</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">hasRoute(name: RouteRecordName): <span class="built_in">boolean</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasRoute</span>(<span class="params">name: RouteRecordName</span>): <span class="title">boolean</span> </span>{</span><br><span class="line">  <span class="comment">// 从matcherMap里面找的</span></span><br><span class="line">  <span class="keyword">return</span> !!matcher.getRecordMatcher(name)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="getRoutes"><a href="#getRoutes" class="headerlink" title="getRoutes"></a>getRoutes</h3><p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#getroutes">官方文档 getRoutes</a><br>获取所有 路由记录的完整列表。就是你写的route list</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get a full list of all the {<span class="doctag">@link </span>RouteRecord | route records}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">getRoutes(): RouteRecord[]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRoutes</span>(<span class="params"></span>) </span>{、</span><br><span class="line">  <span class="comment">// 只拿record记录，就是</span></span><br><span class="line">  <span class="keyword">return</span> matcher.getRoutes().map(<span class="function"><span class="params">routeMatcher</span> =&gt;</span> routeMatcher.record)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve</h3><p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#resolve">官方文档 resolve</a><br>解析路由地址，返回标准的路由对象<br> 返回 标准路由对象，并且带一个href 属性。默认情况，currentLocation 是 route.currrentRoute 也就是当前路由， 并且它只能在高级用例里面被覆盖（意思就是不要传这个参数）</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the {<span class="doctag">@link </span>RouteLocation | normalized version} of a</span></span><br><span class="line"><span class="comment">   * {<span class="doctag">@link </span>RouteLocationRaw | route location}. Also includes an `href` property</span></span><br><span class="line"><span class="comment">   * that includes any existing `base`. By default, the `currentLocation` used is</span></span><br><span class="line"><span class="comment">   * `route.currentRoute` and should only be overridden in advanced use cases.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">to</span></span> - Raw route location to resolve</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">currentLocation</span></span> - Optional current location to resolve against</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">resolve(</span><br><span class="line">  to: RouteLocationRaw,</span><br><span class="line">  currentLocation?: RouteLocationNormalizedLoaded</span><br><span class="line">): RouteLocation &amp; { <span class="attr">href</span>: <span class="built_in">string</span> }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  rawLocation: Readonly&lt;RouteLocationRaw&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  currentLocation?: RouteLocationNormalizedLoaded</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouteLocation</span> &amp; </span>{ href: <span class="built_in">string</span> } {</span><br><span class="line">  <span class="comment">// const objectLocation = routerLocationAsObject(rawLocation)</span></span><br><span class="line">  <span class="comment">// we create a copy to modify it later</span></span><br><span class="line">  <span class="comment">// 默认就是拿的 currentRoute的值，因为是个ref 所以取的是value 值</span></span><br><span class="line">  currentLocation = assign({}, currentLocation || currentRoute.value)</span><br><span class="line">  <span class="comment">// 如果是个字符串， 也就是传了一个 path</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rawLocation === <span class="string">'string'</span>) {</span><br><span class="line">    <span class="comment">// 拿到规范化的loacation, 就是{fullPath, path, query, hash}</span></span><br><span class="line">    <span class="keyword">const</span> locationNormalized = parseURL(</span><br><span class="line">      parseQuery,</span><br><span class="line">      rawLocation,</span><br><span class="line">      currentLocation.path</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 拿到 matcher</span></span><br><span class="line">    <span class="keyword">const</span> matchedRoute = matcher.resolve(</span><br><span class="line">      { <span class="attr">path</span>: locationNormalized.path },</span><br><span class="line">      currentLocation</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 拿到hash后面的字符串</span></span><br><span class="line">    <span class="keyword">const</span> href = routerHistory.createHref(locationNormalized.fullPath)</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) {</span><br><span class="line">      <span class="keyword">if</span> (href.startsWith(<span class="string">'//'</span>))</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Location "<span class="subst">${rawLocation}</span>" resolved to "<span class="subst">${href}</span>". A resolved location cannot start with multiple slashes.`</span></span><br><span class="line">        )</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!matchedRoute.matched.length) {</span><br><span class="line">        warn(<span class="string">`No match found for location with path "<span class="subst">${rawLocation}</span>"`</span>)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// locationNormalized is always a new object</span></span><br><span class="line">    <span class="comment">// 把这几个合并一下</span></span><br><span class="line">    <span class="keyword">return</span> assign(locationNormalized, matchedRoute, {</span><br><span class="line">      <span class="attr">params</span>: decodeParams(matchedRoute.params),</span><br><span class="line">      <span class="attr">hash</span>: decode(locationNormalized.hash),</span><br><span class="line">      <span class="attr">redirectedFrom</span>: <span class="literal">undefined</span>,</span><br><span class="line">      href,</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> matcherLocation: MatcherLocationRaw</span><br><span class="line"></span><br><span class="line">  <span class="comment">// path could be relative in object as well</span></span><br><span class="line">  <span class="comment">// 如果带有pach 对象</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'path'</span> <span class="keyword">in</span> rawLocation) {</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      <span class="string">'params'</span> <span class="keyword">in</span> rawLocation &amp;&amp;</span><br><span class="line">      !(<span class="string">'name'</span> <span class="keyword">in</span> rawLocation) &amp;&amp;</span><br><span class="line">      <span class="comment">// @ts-expect-error: the type is never</span></span><br><span class="line">      <span class="built_in">Object</span>.keys(rawLocation.params).length</span><br><span class="line">    ) {</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Path "<span class="subst">${</span></span></span><br><span class="line"><span class="subst"><span class="string">          <span class="regexp">//</span> @ts-expect-error: the <span class="keyword">type</span> is <span class="built_in">never</span></span></span></span><br><span class="line"><span class="subst"><span class="string">          rawLocation.path</span></span></span><br><span class="line"><span class="subst"><span class="string">        }</span>" was passed with params but they will be ignored. Use a named route alongside params instead.`</span></span><br><span class="line">      )</span><br><span class="line">    }</span><br><span class="line">    matcherLocation = assign({}, rawLocation, {</span><br><span class="line">      <span class="attr">path</span>: parseURL(parseQuery, rawLocation.path, currentLocation.path).path,</span><br><span class="line">    })</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// remove any nullish param</span></span><br><span class="line">    <span class="keyword">const</span> targetParams = assign({}, rawLocation.params)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> targetParams) {</span><br><span class="line">      <span class="keyword">if</span> (targetParams[key] == <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">delete</span> targetParams[key]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// pass encoded values to the matcher, so it can produce encoded path and fullPath</span></span><br><span class="line">    matcherLocation = assign({}, rawLocation, {</span><br><span class="line">      <span class="attr">params</span>: encodeParams(rawLocation.params),</span><br><span class="line">    })</span><br><span class="line">    <span class="comment">// current location params are decoded, we need to encode them in case the</span></span><br><span class="line">    <span class="comment">// matcher merges the params</span></span><br><span class="line">    currentLocation.params = encodeParams(currentLocation.params)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> matchedRoute = matcher.resolve(matcherLocation, currentLocation)</span><br><span class="line">  <span class="keyword">const</span> hash = rawLocation.hash || <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; hash &amp;&amp; !hash.startsWith(<span class="string">'#'</span>)) {</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`A \`hash\` should always start with the character "#". Replace "<span class="subst">${hash}</span>" with "#<span class="subst">${hash}</span>".`</span></span><br><span class="line">    )</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the matcher might have merged current location params, so</span></span><br><span class="line">  <span class="comment">// we need to run the decoding again</span></span><br><span class="line">  matchedRoute.params = normalizeParams(decodeParams(matchedRoute.params))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fullPath = stringifyURL(</span><br><span class="line">    stringifyQuery,</span><br><span class="line">    assign({}, rawLocation, {</span><br><span class="line">      <span class="attr">hash</span>: encodeHash(hash),</span><br><span class="line">      <span class="attr">path</span>: matchedRoute.path,</span><br><span class="line">    })</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> href = routerHistory.createHref(fullPath)</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) {</span><br><span class="line">    <span class="keyword">if</span> (href.startsWith(<span class="string">'//'</span>)) {</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Location "<span class="subst">${rawLocation}</span>" resolved to "<span class="subst">${href}</span>". A resolved location cannot start with multiple slashes.`</span></span><br><span class="line">      )</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!matchedRoute.matched.length) {</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`No match found for location with path "<span class="subst">${</span></span></span><br><span class="line"><span class="subst"><span class="string">          <span class="string">'path'</span> <span class="keyword">in</span> rawLocation ? rawLocation.path : rawLocation</span></span></span><br><span class="line"><span class="subst"><span class="string">        }</span>"`</span></span><br><span class="line">      )</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> assign(</span><br><span class="line">    {</span><br><span class="line">      fullPath,</span><br><span class="line">      <span class="comment">// keep the hash encoded so fullPath is effectively path + encodedQuery +</span></span><br><span class="line">      <span class="comment">// hash</span></span><br><span class="line">      hash,</span><br><span class="line">      <span class="attr">query</span>:</span><br><span class="line">        <span class="comment">// if the user is using a custom query lib like qs, we might have</span></span><br><span class="line">        <span class="comment">// nested objects, so we keep the query as is, meaning it can contain</span></span><br><span class="line">        <span class="comment">// numbers at `$route.query`, but at the point, the user will have to</span></span><br><span class="line">        <span class="comment">// use their own type anyway.</span></span><br><span class="line">        <span class="comment">// https://github.com/vuejs/router/issues/328#issuecomment-649481567</span></span><br><span class="line">        stringifyQuery === originalStringifyQuery</span><br><span class="line">          ? normalizeQuery(rawLocation.query)</span><br><span class="line">          : ((rawLocation.query || {}) <span class="keyword">as</span> LocationQuery),</span><br><span class="line">    },</span><br><span class="line">    matchedRoute,</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">redirectedFrom</span>: <span class="literal">undefined</span>,</span><br><span class="line">      href,</span><br><span class="line">    }</span><br><span class="line">  )</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="History-相关"><a href="#History-相关" class="headerlink" title="History 相关"></a>History 相关</h2><h3 id="push"><a href="#push" class="headerlink" title="push"></a>push</h3><p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#push">官方文档 push</a><br>通过在历史堆栈中推送一个 entry，以编程方式导航到一个新的 URL。<br>就是History.pushState 一个状态，然后执行popState 触发路由切换。</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Programmatically navigate to a new URL by pushing an entry in the history</span></span><br><span class="line"><span class="comment"> * stack.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">to</span></span> - Route location to navigate to</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">push(to: RouteLocationRaw): <span class="built_in">Promise</span>&lt;NavigationFailure | <span class="built_in">void</span> | <span class="literal">undefined</span>&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">to: RouteLocationRaw</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> pushWithRedirect(to)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="pushWithRedirect"><a href="#pushWithRedirect" class="headerlink" title="pushWithRedirect"></a>pushWithRedirect</h4><figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushWithRedirect</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  to: RouteLocationRaw | RouteLocation,</span></span></span><br><span class="line"><span class="params"><span class="function">  redirectedFrom?: RouteLocation</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Promise</span>&lt;<span class="title">NavigationFailure</span> | <span class="title">void</span> | <span class="title">undefined</span>&gt; </span>{</span><br><span class="line">  <span class="comment">// 目标跳转的location</span></span><br><span class="line">  <span class="keyword">const</span> targetLocation: RouteLocation = (pendingLocation = resolve(to))</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">from</span> = currentRoute.value</span><br><span class="line">  <span class="keyword">const</span> data: HistoryState | <span class="literal">undefined</span> = (to <span class="keyword">as</span> RouteLocationOptions).state</span><br><span class="line">  <span class="keyword">const</span> force: <span class="built_in">boolean</span> | <span class="literal">undefined</span> = (to <span class="keyword">as</span> RouteLocationOptions).force</span><br><span class="line">  <span class="comment">// to could be a string where `replace` is a function</span></span><br><span class="line">  <span class="keyword">const</span> replace = (to <span class="keyword">as</span> RouteLocationOptions).replace === <span class="literal">true</span></span><br><span class="line">  <span class="comment">// 是否重定向</span></span><br><span class="line">  <span class="keyword">const</span> shouldRedirect = handleRedirectRecord(targetLocation)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shouldRedirect)</span><br><span class="line">    <span class="keyword">return</span> pushWithRedirect(</span><br><span class="line">      assign(locationAsObject(shouldRedirect), {</span><br><span class="line">        <span class="attr">state</span>:</span><br><span class="line">          <span class="keyword">typeof</span> shouldRedirect === <span class="string">'object'</span></span><br><span class="line">            ? assign({}, data, shouldRedirect.state)</span><br><span class="line">            : data,</span><br><span class="line">        force,</span><br><span class="line">        replace,</span><br><span class="line">      }),</span><br><span class="line">      <span class="comment">// keep original redirectedFrom if it exists</span></span><br><span class="line">      redirectedFrom || targetLocation</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if it was a redirect we already called `pushWithRedirect` above</span></span><br><span class="line">  <span class="keyword">const</span> toLocation = targetLocation <span class="keyword">as</span> RouteLocationNormalized</span><br><span class="line"></span><br><span class="line">  toLocation.redirectedFrom = redirectedFrom</span><br><span class="line">  <span class="keyword">let</span> failure: NavigationFailure | <span class="built_in">void</span> | <span class="literal">undefined</span></span><br><span class="line">  <span class="comment">// 如果 focre 是false 且 目标路由和当前路由一样， 就构建异常failure</span></span><br><span class="line">  <span class="comment">// force 为true, 如果目标和当前一致也会触发路由导航</span></span><br><span class="line">  <span class="keyword">if</span> (!force &amp;&amp; isSameRouteLocation(stringifyQuery, <span class="keyword">from</span>, targetLocation)) {</span><br><span class="line">    failure = createRouterError&lt;NavigationFailure&gt;(</span><br><span class="line">      ErrorTypes.NAVIGATION_DUPLICATED,</span><br><span class="line">      { <span class="attr">to</span>: toLocation, <span class="keyword">from</span> }</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// trigger scroll to allow scrolling to the same anchor</span></span><br><span class="line">    handleScroll(</span><br><span class="line">      <span class="keyword">from</span>,</span><br><span class="line">      <span class="keyword">from</span>,</span><br><span class="line">      <span class="comment">// this is a push, the only way for it to be triggered from a</span></span><br><span class="line">      <span class="comment">// history.listen is with a redirect, which makes it become a push</span></span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">// This cannot be the first navigation because the initial location</span></span><br><span class="line">      <span class="comment">// cannot be manually navigated to</span></span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    )</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 如果不能push（相同路由），就在下一个事件循环抛出</span></span><br><span class="line">  <span class="comment">// 如果可以， 执行navigate函数</span></span><br><span class="line">  <span class="keyword">return</span> (failure ? <span class="built_in">Promise</span>.resolve(failure) : navigate(toLocation, <span class="keyword">from</span>))</span><br><span class="line">    .catch(<span class="function">(<span class="params">error: NavigationFailure | NavigationRedirectError</span>) =&gt;</span></span><br><span class="line">      isNavigationFailure(error)</span><br><span class="line">        ? <span class="comment">// navigation redirects still mark the router as ready</span></span><br><span class="line">          isNavigationFailure(error, ErrorTypes.NAVIGATION_GUARD_REDIRECT)</span><br><span class="line">          ? error</span><br><span class="line">          : markAsReady(error) <span class="comment">// also returns the error</span></span><br><span class="line">        : <span class="comment">// reject any unknown error</span></span><br><span class="line">          triggerError(error, toLocation, <span class="keyword">from</span>)</span><br><span class="line">    )</span><br><span class="line">    .then(<span class="function">(<span class="params">failure: NavigationFailure | NavigationRedirectError | <span class="built_in">void</span></span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (failure) {</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          isNavigationFailure(failure, ErrorTypes.NAVIGATION_GUARD_REDIRECT)</span><br><span class="line">        ) {</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            __DEV__ &amp;&amp;</span><br><span class="line">            <span class="comment">// we are redirecting to the same location we were already at</span></span><br><span class="line">            isSameRouteLocation(</span><br><span class="line">              stringifyQuery,</span><br><span class="line">              resolve(failure.to),</span><br><span class="line">              toLocation</span><br><span class="line">            ) &amp;&amp;</span><br><span class="line">            <span class="comment">// and we have done it a couple of times</span></span><br><span class="line">            redirectedFrom &amp;&amp;</span><br><span class="line">            <span class="comment">// @ts-expect-error: added only in dev</span></span><br><span class="line">            (redirectedFrom._count = redirectedFrom._count</span><br><span class="line">              ? <span class="comment">// @ts-expect-error</span></span><br><span class="line">                redirectedFrom._count + <span class="number">1</span></span><br><span class="line">              : <span class="number">1</span>) &gt; <span class="number">10</span></span><br><span class="line">          ) {</span><br><span class="line">            warn(</span><br><span class="line">              <span class="string">`Detected an infinite redirection in a navigation guard when going from "<span class="subst">${<span class="keyword">from</span>.fullPath}</span>" to "<span class="subst">${toLocation.fullPath}</span>". Aborting to avoid a Stack Overflow. This will break in production if not fixed.`</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(</span><br><span class="line">              <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Infinite redirect in navigation guard'</span>)</span><br><span class="line">            )</span><br><span class="line">          }</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> pushWithRedirect(</span><br><span class="line">            <span class="comment">// keep options</span></span><br><span class="line">            assign(</span><br><span class="line">              {</span><br><span class="line">                <span class="comment">// preserve an existing replacement but allow the redirect to override it</span></span><br><span class="line">                replace,</span><br><span class="line">              },</span><br><span class="line">              locationAsObject(failure.to),</span><br><span class="line">              {</span><br><span class="line">                <span class="attr">state</span>:</span><br><span class="line">                  <span class="keyword">typeof</span> failure.to === <span class="string">'object'</span></span><br><span class="line">                    ? assign({}, data, failure.to.state)</span><br><span class="line">                    : data,</span><br><span class="line">                force,</span><br><span class="line">              }</span><br><span class="line">            ),</span><br><span class="line">            <span class="comment">// preserve the original redirectedFrom if any</span></span><br><span class="line">            redirectedFrom || toLocation</span><br><span class="line">          )</span><br><span class="line">        }</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// if we fail we don't finalize the navigation</span></span><br><span class="line">        failure = finalizeNavigation(</span><br><span class="line">          toLocation <span class="keyword">as</span> RouteLocationNormalizedLoaded,</span><br><span class="line">          <span class="keyword">from</span>,</span><br><span class="line">          <span class="literal">true</span>,</span><br><span class="line">          replace,</span><br><span class="line">          data</span><br><span class="line">        )</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// afterEach 守卫</span></span><br><span class="line">      triggerAfterEach(</span><br><span class="line">        toLocation <span class="keyword">as</span> RouteLocationNormalizedLoaded,</span><br><span class="line">        <span class="keyword">from</span>,</span><br><span class="line">        failure</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> failure</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="handleRedirectRecord"><a href="#handleRedirectRecord" class="headerlink" title="handleRedirectRecord"></a>handleRedirectRecord</h4><figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleRedirectRecord</span>(<span class="params">to: RouteLocation</span>): <span class="title">RouteLocationRaw</span> | <span class="title">void</span> </span>{</span><br><span class="line">  <span class="comment">// 匹配的路由record</span></span><br><span class="line">  <span class="keyword">const</span> lastMatched = to.matched[to.matched.length - <span class="number">1</span>]</span><br><span class="line">  <span class="comment">// 如果有重定向</span></span><br><span class="line">  <span class="comment">// 如果没有就没有返回值</span></span><br><span class="line">  <span class="keyword">if</span> (lastMatched &amp;&amp; lastMatched.redirect) {</span><br><span class="line">    <span class="keyword">const</span> { redirect } = lastMatched</span><br><span class="line">    <span class="keyword">let</span> newTargetLocation =</span><br><span class="line">      <span class="keyword">typeof</span> redirect === <span class="string">'function'</span> ? redirect(to) : redirect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newTargetLocation === <span class="string">'string'</span>) {</span><br><span class="line">      newTargetLocation =</span><br><span class="line">        newTargetLocation.includes(<span class="string">'?'</span>) || newTargetLocation.includes(<span class="string">'#'</span>)</span><br><span class="line">          ? (newTargetLocation = locationAsObject(newTargetLocation))</span><br><span class="line">          : <span class="comment">// force empty params</span></span><br><span class="line">            { <span class="attr">path</span>: newTargetLocation }</span><br><span class="line">      <span class="comment">// @ts-expect-error: force empty params when a string is passed to let</span></span><br><span class="line">      <span class="comment">// the router parse them again</span></span><br><span class="line">      newTargetLocation.params = {}</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      !(<span class="string">'path'</span> <span class="keyword">in</span> newTargetLocation) &amp;&amp;</span><br><span class="line">      !(<span class="string">'name'</span> <span class="keyword">in</span> newTargetLocation)</span><br><span class="line">    ) {</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Invalid redirect found:\n<span class="subst">${<span class="built_in">JSON</span>.stringify(</span></span></span><br><span class="line"><span class="subst"><span class="string">          newTargetLocation,</span></span></span><br><span class="line"><span class="subst"><span class="string">          <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="subst"><span class="string">          <span class="number">2</span></span></span></span><br><span class="line"><span class="subst"><span class="string">        )}</span>\n when navigating to "<span class="subst">${</span></span></span><br><span class="line"><span class="subst"><span class="string">          to.fullPath</span></span></span><br><span class="line"><span class="subst"><span class="string">        }</span>". A redirect must contain a name or path. This will break in production.`</span></span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Invalid redirect'</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> assign(</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">query</span>: to.query,</span><br><span class="line">        <span class="attr">hash</span>: to.hash,</span><br><span class="line">        <span class="comment">// avoid transferring params if the redirect has a path</span></span><br><span class="line">        <span class="attr">params</span>: <span class="string">'path'</span> <span class="keyword">in</span> newTargetLocation ? {} : to.params,</span><br><span class="line">      },</span><br><span class="line">      newTargetLocation</span><br><span class="line">    )</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="navigate"><a href="#navigate" class="headerlink" title="navigate"></a>navigate</h4><figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">navigate</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  to: RouteLocationNormalized,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">from</span>: RouteLocationNormalizedLoaded</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Promise</span>&lt;<span class="title">any</span>&gt; </span>{</span><br><span class="line">  <span class="comment">// 路由守卫</span></span><br><span class="line">  <span class="keyword">let</span> guards: Lazy&lt;<span class="built_in">any</span>&gt;[]</span><br><span class="line">  <span class="comment">// 提炼出record</span></span><br><span class="line">  <span class="keyword">const</span> [leavingRecords, updatingRecords, enteringRecords] =</span><br><span class="line">    extractChangingRecords(to, <span class="keyword">from</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// all components here have been resolved once because we are leaving</span></span><br><span class="line">  <span class="comment">// 找到需要触发 beforeRouteLeave 的路由守卫</span></span><br><span class="line">  guards = extractComponentsGuards(</span><br><span class="line">    leavingRecords.reverse(),</span><br><span class="line">    <span class="string">'beforeRouteLeave'</span>,</span><br><span class="line">    to,</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// leavingRecords is already reversed</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> record <span class="keyword">of</span> leavingRecords) {</span><br><span class="line">    record.leaveGuards.forEach(<span class="function"><span class="params">guard</span> =&gt;</span> {</span><br><span class="line">      guards.push(guardToPromiseFn(guard, to, <span class="keyword">from</span>))</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 取消导航</span></span><br><span class="line">  <span class="keyword">const</span> canceledNavigationCheck = checkCanceledNavigationAndReject.bind(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    to,</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  guards.push(canceledNavigationCheck)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// run the queue of per route beforeRouteLeave guards</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// 执行所有守卫</span></span><br><span class="line">    <span class="comment">// 按顺序执行守卫 beforeRouteLeave beforeEach  beforeRouteUpdate beforeEnter  beforeRouteEnter beforeResolve</span></span><br><span class="line">    runGuardQueue(guards)</span><br><span class="line">      .then(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// check global guards beforeEach</span></span><br><span class="line">        guards = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> guard <span class="keyword">of</span> beforeGuards.list()) {</span><br><span class="line">          guards.push(guardToPromiseFn(guard, to, <span class="keyword">from</span>))</span><br><span class="line">        }</span><br><span class="line">        guards.push(canceledNavigationCheck)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> runGuardQueue(guards)</span><br><span class="line">      })</span><br><span class="line">      .then(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// check in components beforeRouteUpdate</span></span><br><span class="line">        guards = extractComponentsGuards(</span><br><span class="line">          updatingRecords,</span><br><span class="line">          <span class="string">'beforeRouteUpdate'</span>,</span><br><span class="line">          to,</span><br><span class="line">          <span class="keyword">from</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> record <span class="keyword">of</span> updatingRecords) {</span><br><span class="line">          record.updateGuards.forEach(<span class="function"><span class="params">guard</span> =&gt;</span> {</span><br><span class="line">            guards.push(guardToPromiseFn(guard, to, <span class="keyword">from</span>))</span><br><span class="line">          })</span><br><span class="line">        }</span><br><span class="line">        guards.push(canceledNavigationCheck)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// run the queue of per route beforeEnter guards</span></span><br><span class="line">        <span class="keyword">return</span> runGuardQueue(guards)</span><br><span class="line">      })</span><br><span class="line">      .then(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// check the route beforeEnter</span></span><br><span class="line">        guards = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> record <span class="keyword">of</span> to.matched) {</span><br><span class="line">          <span class="comment">// do not trigger beforeEnter on reused views</span></span><br><span class="line">          <span class="keyword">if</span> (record.beforeEnter &amp;&amp; !<span class="keyword">from</span>.matched.includes(record)) {</span><br><span class="line">            <span class="keyword">if</span> (isArray(record.beforeEnter)) {</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">const</span> beforeEnter <span class="keyword">of</span> record.beforeEnter)</span><br><span class="line">                guards.push(guardToPromiseFn(beforeEnter, to, <span class="keyword">from</span>))</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">              guards.push(guardToPromiseFn(record.beforeEnter, to, <span class="keyword">from</span>))</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        guards.push(canceledNavigationCheck)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// run the queue of per route beforeEnter guards</span></span><br><span class="line">        <span class="keyword">return</span> runGuardQueue(guards)</span><br><span class="line">      })</span><br><span class="line">      .then(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> at this point to.matched is normalized and does not contain any () =&gt; Promise&lt;Component&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// clear existing enterCallbacks, these are added by extractComponentsGuards</span></span><br><span class="line">        to.matched.forEach(<span class="function"><span class="params">record</span> =&gt;</span> (record.enterCallbacks = {}))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// check in-component beforeRouteEnter</span></span><br><span class="line">        guards = extractComponentsGuards(</span><br><span class="line">          enteringRecords,</span><br><span class="line">          <span class="string">'beforeRouteEnter'</span>,</span><br><span class="line">          to,</span><br><span class="line">          <span class="keyword">from</span></span><br><span class="line">        )</span><br><span class="line">        guards.push(canceledNavigationCheck)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// run the queue of per route beforeEnter guards</span></span><br><span class="line">        <span class="keyword">return</span> runGuardQueue(guards)</span><br><span class="line">      })</span><br><span class="line">      .then(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// check global guards beforeResolve</span></span><br><span class="line">        guards = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> guard <span class="keyword">of</span> beforeResolveGuards.list()) {</span><br><span class="line">          guards.push(guardToPromiseFn(guard, to, <span class="keyword">from</span>))</span><br><span class="line">        }</span><br><span class="line">        guards.push(canceledNavigationCheck)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> runGuardQueue(guards)</span><br><span class="line">      })</span><br><span class="line">      <span class="comment">// catch any navigation canceled</span></span><br><span class="line">      .catch(<span class="function"><span class="params">err</span> =&gt;</span></span><br><span class="line">        isNavigationFailure(err, ErrorTypes.NAVIGATION_CANCELLED)</span><br><span class="line">          ? err</span><br><span class="line">          : <span class="built_in">Promise</span>.reject(err)</span><br><span class="line">      )</span><br><span class="line">  )</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="extractChangingRecords"><a href="#extractChangingRecords" class="headerlink" title="extractChangingRecords"></a>extractChangingRecords</h4><p>提炼出需要的record</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractChangingRecords</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  to: RouteLocationNormalized,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">from</span>: RouteLocationNormalizedLoaded</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>{</span><br><span class="line">  <span class="comment">// 离开的record</span></span><br><span class="line">  <span class="keyword">const</span> leavingRecords: RouteRecordNormalized[] = []</span><br><span class="line">  <span class="comment">// 需要更新的record</span></span><br><span class="line">  <span class="keyword">const</span> updatingRecords: RouteRecordNormalized[] = []</span><br><span class="line">  <span class="comment">// 进入的record</span></span><br><span class="line">  <span class="keyword">const</span> enteringRecords: RouteRecordNormalized[] = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> len = <span class="built_in">Math</span>.max(<span class="keyword">from</span>.matched.length, to.matched.length)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) {</span><br><span class="line">    <span class="keyword">const</span> recordFrom = <span class="keyword">from</span>.matched[i]</span><br><span class="line">    <span class="keyword">if</span> (recordFrom) {</span><br><span class="line">      <span class="keyword">if</span> (to.matched.find(<span class="function"><span class="params">record</span> =&gt;</span> isSameRouteRecord(record, recordFrom)))</span><br><span class="line">        updatingRecords.push(recordFrom)</span><br><span class="line">      <span class="keyword">else</span> leavingRecords.push(recordFrom)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">const</span> recordTo = to.matched[i]</span><br><span class="line">    <span class="keyword">if</span> (recordTo) {</span><br><span class="line">      <span class="comment">// the type doesn't matter because we are comparing per reference</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">from</span>.matched.find(<span class="function"><span class="params">record</span> =&gt;</span> isSameRouteRecord(record, recordTo))) {</span><br><span class="line">        enteringRecords.push(recordTo)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [leavingRecords, updatingRecords, enteringRecords]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="runGuardQueue"><a href="#runGuardQueue" class="headerlink" title="runGuardQueue"></a>runGuardQueue</h4><p>执行守卫队列</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runGuardQueue</span>(<span class="params">guards: Lazy&lt;<span class="built_in">any</span>&gt;[]</span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>{</span><br><span class="line">  <span class="keyword">return</span> guards.reduce(</span><br><span class="line">    <span class="comment">// 这是放在下一个事件循环里面执行</span></span><br><span class="line">    <span class="function">(<span class="params">promise, guard</span>) =&gt;</span> promise.then(<span class="function">() =&gt;</span> guard()),</span><br><span class="line">    <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  )</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h3><p>通过替换历史堆栈中的当前 entry，以编程方式导航到一个新的 URL。<br><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#replace">官方文档 replace</a></p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace</span>(<span class="params">to: RouteLocationRaw</span>) </span>{</span><br><span class="line">  <span class="comment">// 套壳push</span></span><br><span class="line">  <span class="keyword">return</span> push(assign(locationAsObject(to), { <span class="attr">replace</span>: <span class="literal">true</span> }))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="go"><a href="#go" class="headerlink" title="go"></a>go</h3><p>允许你在历史中前进或后退。<br><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#go">官方文档 go</a></p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> go = <span class="function">(<span class="params">delta: <span class="built_in">number</span></span>) =&gt;</span> routerHistory.go(delta)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="back"><a href="#back" class="headerlink" title="back"></a>back</h3><p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#back">官方文档 back</a></p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">back: <span class="function">() =&gt;</span> go(-<span class="number">1</span>),</span><br></pre></td></tr></tbody></table></figure>
<h3 id="forward"><a href="#forward" class="headerlink" title="forward"></a>forward</h3><p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#forward">官方文档 forward</a></p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forward: <span class="function">() =&gt;</span> go(<span class="number">1</span>),</span><br></pre></td></tr></tbody></table></figure>
<h2 id="全局导航守卫"><a href="#全局导航守卫" class="headerlink" title="全局导航守卫"></a>全局导航守卫</h2><h3 id="beforeEach-amp-beforeResolve-amp-afterEach"><a href="#beforeEach-amp-beforeResolve-amp-afterEach" class="headerlink" title="beforeEach &amp; beforeResolve &amp; afterEach"></a>beforeEach &amp; beforeResolve &amp; afterEach</h3><p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#beforeeach">官方文档 beforeEach</a><br>全局守卫， 添加一个导航守卫，在任何导航前执行。返回一个删除已注册守卫的函数。</p>
<p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#beforeresolve">官方文档 beforeResolve</a><br>添加一个导航守卫，在导航即将解析之前执行。在这个状态下，所有的组件都已经被获取，并且其他导航守卫也已经成功。返回一个删除已注册守卫的函数。<br><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#aftereach">官方文档 afterEach</a><br>添加一个导航钩子，在每次导航后执行。返回一个删除注册钩子的函数。</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">beforeEach: beforeGuards.add,</span><br><span class="line"><span class="attr">beforeResolve</span>: beforeResolveGuards.add,</span><br><span class="line"><span class="attr">afterEach</span>: afterGuards.add,</span><br></pre></td></tr></tbody></table></figure>

<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><h3 id="onError"><a href="#onError" class="headerlink" title="onError"></a>onError</h3><p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#onerror">官方文档 onError</a><br>添加一个错误处理程序，在导航期间每次发生未捕获的错误时都会调用该处理程序。这包括同步和异步抛出的错误、在任何导航守卫中返回或传递给 next 的错误，以及在试图解析渲染路由所需的异步组件时发生的错误。</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 之前构造的异常回调对象的 add 函数</span></span><br><span class="line"><span class="attr">onError</span>: errorHandlers.add,</span><br></pre></td></tr></tbody></table></figure>
<h3 id="isReady"><a href="#isReady" class="headerlink" title="isReady"></a>isReady</h3><p><a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/api/#isready">官方文档 isReady</a><br>当路由器完成初始化导航时，返回一个 Promise，这意味着它已经解析了所有与初始路由相关的异步输入钩子和异步组件。如果初始导航已经发生了，那么 promise 就会立即解析。这在服务器端渲染中很有用，可以确保服务器和客户端的输出一致。需要注意的是，在服务器端，你需要手动推送初始位置，而在客户端，路由器会自动从 URL 中获取初始位置。</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isReady</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>{</span><br><span class="line">  <span class="keyword">if</span> (ready &amp;&amp; currentRoute.value !== START_LOCATION_NORMALIZED)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">    <span class="comment">// 添加到ready的回调队列</span></span><br><span class="line">    readyHandlers.add([resolve, reject])</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="install"><a href="#install" class="headerlink" title="install"></a>install</h3><p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/guide/reusability/plugins.html#introduction">官方文档 vue插件</a><br>安装函数，注册为vue 插件的</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">install</span>(<span class="params">app: App</span>)</span> {</span><br><span class="line">  <span class="keyword">const</span> router = <span class="built_in">this</span></span><br><span class="line">  <span class="comment">// 注册两个全局组件</span></span><br><span class="line">  app.component(<span class="string">'RouterLink'</span>, RouterLink)</span><br><span class="line">  app.component(<span class="string">'RouterView'</span>, RouterView)</span><br><span class="line">  <span class="comment">// vue中 router 的位置</span></span><br><span class="line">  app.config.globalProperties.$router = router</span><br><span class="line">  <span class="comment">// 数据劫持，vue组件每一个都有$route属性</span></span><br><span class="line">  <span class="comment">// 添加全局的属性</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(app.config.globalProperties, <span class="string">'$route'</span>, {</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> unref(currentRoute),</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="comment">// this initial navigation is only necessary on client, on server it doesn't</span></span><br><span class="line">  <span class="comment">// make sense because it will create an extra unnecessary navigation and could</span></span><br><span class="line">  <span class="comment">// lead to problems</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isBrowser &amp;&amp;</span><br><span class="line">    <span class="comment">// used for the initial navigation client side to avoid pushing</span></span><br><span class="line">    <span class="comment">// multiple times when the router is used in multiple apps</span></span><br><span class="line">    !started &amp;&amp;</span><br><span class="line">    currentRoute.value === START_LOCATION_NORMALIZED</span><br><span class="line">  ) {</span><br><span class="line">    <span class="comment">// see above</span></span><br><span class="line">    started = <span class="literal">true</span></span><br><span class="line">    push(routerHistory.location).catch(<span class="function"><span class="params">err</span> =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) warn(<span class="string">'Unexpected error when starting the router:'</span>, err)</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> reactiveRoute = {} <span class="keyword">as</span> {</span><br><span class="line">    [k <span class="keyword">in</span> keyof RouteLocationNormalizedLoaded]: ComputedRef&lt;</span><br><span class="line">      RouteLocationNormalizedLoaded[k]</span><br><span class="line">    &gt;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> START_LOCATION_NORMALIZED) {</span><br><span class="line">    <span class="comment">// @ts-expect-error: the key matches</span></span><br><span class="line">    reactiveRoute[key] = computed(<span class="function">() =&gt;</span> currentRoute.value[key])</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 全局注入的属性</span></span><br><span class="line">  app.provide(routerKey, router)</span><br><span class="line">  app.provide(routeLocationKey, reactive(reactiveRoute))</span><br><span class="line">  app.provide(routerViewLocationKey, currentRoute)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> unmountApp = app.unmount</span><br><span class="line">  installedApps.add(app)</span><br><span class="line">  <span class="comment">// 卸载应用。 这里代理了一下了一下</span></span><br><span class="line">  app.unmount = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    installedApps.delete(app)</span><br><span class="line">    <span class="comment">// the router is not attached to an app anymore</span></span><br><span class="line">    <span class="keyword">if</span> (installedApps.size &lt; <span class="number">1</span>) {</span><br><span class="line">      <span class="comment">// invalidate the current navigation</span></span><br><span class="line">      pendingLocation = START_LOCATION_NORMALIZED</span><br><span class="line">      removeHistoryListener &amp;&amp; removeHistoryListener()</span><br><span class="line">      removeHistoryListener = <span class="literal">null</span></span><br><span class="line">      currentRoute.value = START_LOCATION_NORMALIZED</span><br><span class="line">      started = <span class="literal">false</span></span><br><span class="line">      ready = <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">    unmountApp()</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> this probably needs to be updated so it can be used by vue-termui</span></span><br><span class="line">  <span class="keyword">if</span> ((__DEV__ || __FEATURE_PROD_DEVTOOLS__) &amp;&amp; isBrowser) {</span><br><span class="line">    addDevtools(app, router, matcher)</span><br><span class="line">  }</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure></body></html>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/vue-router/" rel="tag"># vue-router</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/10/18/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%B8%89)/" rel="prev" title="vue-router源码解读(三)">
                  <i class="fa fa-chevron-left"></i> vue-router源码解读(三)
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">灰沙</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/haru01.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":1},"log":false});</script></body>
</html>
