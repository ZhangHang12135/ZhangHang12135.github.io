<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhanghang12135.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="分析vue-router 的每一行代码 – createRouterMatcher">
<meta property="og:type" content="article">
<meta property="og:title" content="vue-router源码解读(三)">
<meta property="og:url" content="https://zhanghang12135.github.io/2022/10/18/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%B8%89)/index.html">
<meta property="og:site_name" content="H.S.">
<meta property="og:description" content="分析vue-router 的每一行代码 – createRouterMatcher">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zhanghang12135.github.io/2022/10/18/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%B8%89)/cover.jpg">
<meta property="article:published_time" content="2022-10-18T00:52:13.000Z">
<meta property="article:modified_time" content="2022-11-12T14:42:18.938Z">
<meta property="article:author" content="灰沙">
<meta property="article:tag" content="vue-router">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhanghang12135.github.io/2022/10/18/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%B8%89)/cover.jpg">


<link rel="canonical" href="https://zhanghang12135.github.io/2022/10/18/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%B8%89)/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zhanghang12135.github.io/2022/10/18/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%B8%89)/","path":"2022/10/18/vue-router源码解读(三)/","title":"vue-router源码解读(三)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>vue-router源码解读(三) | H.S.</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">H.S.</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">成功的人抄袭，伟大的人剽窃</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#createRouterMatcher"><span class="nav-number">1.</span> <span class="nav-text">createRouterMatcher</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#addRoute"><span class="nav-number">1.1.</span> <span class="nav-text">addRoute</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#normalizeRouteRecord-amp-amp-normalizeRecordProps"><span class="nav-number">1.1.1.</span> <span class="nav-text">normalizeRouteRecord &amp;&amp; normalizeRecordProps</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#createRouteRecordMatcher"><span class="nav-number">1.1.2.</span> <span class="nav-text">createRouteRecordMatcher</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#insertMatchers"><span class="nav-number">1.2.</span> <span class="nav-text">insertMatchers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#removeRoute"><span class="nav-number">1.3.</span> <span class="nav-text">removeRoute</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resolve"><span class="nav-number">1.4.</span> <span class="nav-text">resolve</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="灰沙"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">灰沙</p>
  <div class="site-description" itemprop="description">前端个人博客</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
      <span style="margin: 10px 0; font-size:14px">更多文章，微信扫描二维码</span>
      <img src='https://open.weixin.qq.com/qr/code?username=FanRenWeb' width="150px" height="150px"/>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhanghang12135.github.io/2022/10/18/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%B8%89)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="灰沙">
      <meta itemprop="description" content="前端个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="H.S.">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          vue-router源码解读(三)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-18 08:52:13" itemprop="dateCreated datePublished" datetime="2022-10-18T08:52:13+08:00">2022-10-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-12 22:42:18" itemprop="dateModified" datetime="2022-11-12T22:42:18+08:00">2022-11-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <html><head></head><body><div style="width:100%"><img style="width:80%;height:400px" src="/2022/10/18/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%B8%89)/cover.jpg"></div>

<p><strong>分析vue-router 的每一行代码 – createRouterMatcher</strong></p>
<span id="more"></span>
<p>createRouter<br>返回router实例，里面包含了很多方法</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouter</span>(<span class="params">options: RouterOptions</span>): <span class="title">Router</span> </span>{</span><br><span class="line">  <span class="comment">// 返回一个对象，包含addRoute, getRouteMatcher, resolve, romveRoute,getRoutes </span></span><br><span class="line">  <span class="keyword">const</span> matcher = createRouterMatcher(options.routes, options)</span><br><span class="line">  <span class="comment">// ... 下一章解读</span></span><br><span class="line">  <span class="keyword">return</span> router</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="createRouterMatcher"><a href="#createRouterMatcher" class="headerlink" title="createRouterMatcher"></a>createRouterMatcher</h3><p>构建router匹配器</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从接口声明可以看出返回值RouteMatcher</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RouterMatcher {</span><br><span class="line">  <span class="attr">addRoute</span>: <span class="function">(<span class="params">record: RouteRecordRaw, parent?: RouteRecordMatcher</span>) =&gt;</span> <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="attr">removeRoute</span>: {</span><br><span class="line">    (matcher: RouteRecordMatcher): <span class="built_in">void</span></span><br><span class="line">    (name: RouteRecordName): <span class="built_in">void</span></span><br><span class="line">  }</span><br><span class="line">  <span class="attr">getRoutes</span>: <span class="function">() =&gt;</span> RouteRecordMatcher[]</span><br><span class="line">  <span class="attr">getRecordMatcher</span>: <span class="function">(<span class="params">name: RouteRecordName</span>) =&gt;</span> RouteRecordMatcher | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Resolves a location. Gives access to the route record that corresponds to the actual path as well as filling the corresponding params objects</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">location</span></span> - MatcherLocationRaw to resolve to a url</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">currentLocation</span></span> - MatcherLocation of the current location</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">resolve</span>: <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    location: MatcherLocationRaw,</span></span></span><br><span class="line"><span class="params"><span class="function">    currentLocation: MatcherLocation</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> MatcherLocation</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a Router Matcher.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">routes</span></span> - array of initial routes</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">globalOptions</span></span> - global route options</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouterMatcher</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  routes: Readonly&lt;RouteRecordRaw[]&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  globalOptions: PathParserOptions</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouterMatcher</span> </span>{</span><br><span class="line">  <span class="comment">// normalized ordered array of matchers</span></span><br><span class="line">  <span class="comment">// 规范匹配器的顺序</span></span><br><span class="line">  <span class="keyword">const</span> matchers: RouteRecordMatcher[] = []</span><br><span class="line">  <span class="comment">// 匹配器的映射, 带有name的才会添加</span></span><br><span class="line">  <span class="keyword">const</span> matcherMap = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;RouteRecordName, RouteRecordMatcher&gt;()</span><br><span class="line">  <span class="comment">// 全局的options</span></span><br><span class="line">  globalOptions = mergeOptions(</span><br><span class="line">    <span class="comment">// strict  https://router.vuejs.org/zh/api/#strict 严格检查路径末尾是否有尾部斜线（/） 默认 false</span></span><br><span class="line">    <span class="comment">// end 是否添加正则 $ 到最后面 默认 true</span></span><br><span class="line">    <span class="comment">// senstitive 是否区分大小写敏感 默认 false</span></span><br><span class="line">    { <span class="attr">strict</span>: <span class="literal">false</span>, <span class="attr">end</span>: <span class="literal">true</span>, <span class="attr">sensitive</span>: <span class="literal">false</span> } <span class="keyword">as</span> PathParserOptions,</span><br><span class="line">    globalOptions</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getRecordMatcher</span>(<span class="params">name: RouteRecordName</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> matcherMap.get(name)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    record: RouteRecordRaw,</span></span></span><br><span class="line"><span class="params"><span class="function">    parent?: RouteRecordMatcher,</span></span></span><br><span class="line"><span class="params"><span class="function">    originalRecord?: RouteRecordMatcher</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) </span>{</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">removeRoute</span>(<span class="params">matcherRef: RouteRecordName | RouteRecordMatcher</span>) </span>{</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getRoutes</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> matchers</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">insertMatcher</span>(<span class="params">matcher: RouteRecordMatcher</span>) </span>{</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    location: Readonly&lt;MatcherLocationRaw&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    currentLocation: Readonly&lt;MatcherLocation&gt;</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">MatcherLocation</span> </span>{</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add initial routes</span></span><br><span class="line">  <span class="comment">// 添加所有的路由</span></span><br><span class="line">  routes.forEach(<span class="function"><span class="params">route</span> =&gt;</span> addRoute(route))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> { addRoute, resolve, removeRoute, getRoutes, getRecordMatcher }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="addRoute"><a href="#addRoute" class="headerlink" title="addRoute"></a>addRoute</h4><p>添加路由到匹配器映射中</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  record: RouteRecordRaw,</span></span></span><br><span class="line"><span class="params"><span class="function">  parent?: RouteRecordMatcher,</span></span></span><br><span class="line"><span class="params"><span class="function">  originalRecord?: RouteRecordMatcher</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>{</span><br><span class="line">  <span class="comment">// used later on to remove by name</span></span><br><span class="line">  <span class="comment">// 是否有原来的路由，后面根据这个name去移除</span></span><br><span class="line">  <span class="keyword">const</span> isRootAdd = !originalRecord</span><br><span class="line">  <span class="comment">// 规范化路由记录，保证每个路由都是一致的属性</span></span><br><span class="line">  <span class="keyword">const</span> mainNormalizedRecord = normalizeRouteRecord(record)</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) {</span><br><span class="line">      <span class="comment">// 检查没name 或者 path 的就警告</span></span><br><span class="line">    checkChildMissingNameWithEmptyPath(mainNormalizedRecord, parent)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// we might be the child of an alias</span></span><br><span class="line">  mainNormalizedRecord.aliasOf = originalRecord &amp;&amp; originalRecord.record</span><br><span class="line">  <span class="keyword">const</span> options: PathParserOptions = mergeOptions(globalOptions, record)</span><br><span class="line">  <span class="comment">// generate an array of records to correctly handle aliases</span></span><br><span class="line">  <span class="comment">// record 数组，用以处理事件别名</span></span><br><span class="line">  <span class="keyword">const</span> normalizedRecords: <span class="keyword">typeof</span> mainNormalizedRecord[] = [</span><br><span class="line">    mainNormalizedRecord,</span><br><span class="line">  ]</span><br><span class="line">  <span class="comment">// 别名也算一个record，添加到record 数组</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'alias'</span> <span class="keyword">in</span> record) {</span><br><span class="line">    <span class="keyword">const</span> aliases =</span><br><span class="line">      <span class="keyword">typeof</span> record.alias === <span class="string">'string'</span> ? [record.alias] : record.alias!</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> alias <span class="keyword">of</span> aliases) {</span><br><span class="line">      normalizedRecords.push(</span><br><span class="line">        assign({}, mainNormalizedRecord, {</span><br><span class="line">          <span class="comment">// this allows us to hold a copy of the `components` option</span></span><br><span class="line">          <span class="comment">// so that async components cache is hold on the original record</span></span><br><span class="line">          <span class="attr">components</span>: originalRecord</span><br><span class="line">            ? originalRecord.record.components</span><br><span class="line">            : mainNormalizedRecord.components,</span><br><span class="line">          <span class="attr">path</span>: alias,</span><br><span class="line">          <span class="comment">// we might be the child of an alias</span></span><br><span class="line">          <span class="attr">aliasOf</span>: originalRecord</span><br><span class="line">            ? originalRecord.record</span><br><span class="line">            : mainNormalizedRecord,</span><br><span class="line">          <span class="comment">// the aliases are always of the same kind as the original since they</span></span><br><span class="line">          <span class="comment">// are defined on the same record</span></span><br><span class="line">        }) <span class="keyword">as</span> <span class="keyword">typeof</span> mainNormalizedRecord</span><br><span class="line">      )</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> matcher: RouteRecordMatcher</span><br><span class="line">  <span class="keyword">let</span> originalMatcher: RouteRecordMatcher | <span class="literal">undefined</span></span><br><span class="line">  <span class="comment">// 遍历所有的record， 正常长度为1， 如果有alias 就需要多遍历几次</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> normalizedRecord <span class="keyword">of</span> normalizedRecords) {</span><br><span class="line">    <span class="keyword">const</span> { path } = normalizedRecord</span><br><span class="line">    <span class="comment">// Build up the path for nested routes if the child isn't an absolute</span></span><br><span class="line">    <span class="comment">// route. Only add the / delimiter if the child path isn't empty and if the</span></span><br><span class="line">    <span class="comment">// parent path doesn't have a trailing slash</span></span><br><span class="line">    <span class="comment">// 子路径不是空，父路径没有尾部斜杠的时候添加斜杠到path尾部</span></span><br><span class="line">    <span class="keyword">if</span> (parent &amp;&amp; path[<span class="number">0</span>] !== <span class="string">'/'</span>) {</span><br><span class="line">      <span class="keyword">const</span> parentPath = parent.record.path</span><br><span class="line">      <span class="keyword">const</span> connectingSlash =</span><br><span class="line">        parentPath[parentPath.length - <span class="number">1</span>] === <span class="string">'/'</span> ? <span class="string">''</span> : <span class="string">'/'</span></span><br><span class="line">      normalizedRecord.path =</span><br><span class="line">        parent.record.path + (path &amp;&amp; connectingSlash + path)</span><br><span class="line">    }</span><br><span class="line">  <span class="comment">// vue3 删除了 通配符 *</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; normalizedRecord.path === <span class="string">'*'</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">'Catch all routes ("*") must now be defined using a param with a custom regexp.\n'</span> +</span><br><span class="line">          <span class="string">'See more at https://next.router.vuejs.org/guide/migration/#removed-star-or-catch-all-routes.'</span></span><br><span class="line">      )</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the object beforehand, so it can be passed to children</span></span><br><span class="line">    <span class="comment">// 预先创建对象,因此能被发送到子对象</span></span><br><span class="line"></span><br><span class="line">    matcher = createRouteRecordMatcher(normalizedRecord, parent, options)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; parent &amp;&amp; path[<span class="number">0</span>] === <span class="string">'/'</span>)</span><br><span class="line">      checkMissingParamsInAbsolutePath(matcher, parent)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we are an alias we must tell the original record that we exist,</span></span><br><span class="line">    <span class="comment">// so we can be removed</span></span><br><span class="line">    <span class="comment">// 存在源记录，也就是当前是别名的</span></span><br><span class="line">    <span class="keyword">if</span> (originalRecord) {</span><br><span class="line">      originalRecord.alias.push(matcher)</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) {</span><br><span class="line">        checkSameParams(originalRecord, matcher)</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// otherwise, the first record is the original and others are aliases</span></span><br><span class="line">      <span class="comment">// 否则，这个就是源记录</span></span><br><span class="line">      originalMatcher = originalMatcher || matcher</span><br><span class="line">      <span class="comment">// 正常来讲这个逻辑应该走不下去，不知道这个是因为啥</span></span><br><span class="line">      <span class="keyword">if</span> (originalMatcher !== matcher) originalMatcher.alias.push(matcher)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// remove the route if named and only for the top record (avoid in nested calls)</span></span><br><span class="line">      <span class="comment">// this works because the original record is the first one</span></span><br><span class="line">      <span class="comment">// 如果已经存在相同的路由就移除之前的</span></span><br><span class="line">      <span class="comment">// 这个逻辑主要是 手动调用 router.addRoute 会触发</span></span><br><span class="line">      <span class="keyword">if</span> (isRootAdd &amp;&amp; record.name &amp;&amp; !isAliasRecord(matcher))</span><br><span class="line">        removeRoute(record.name)</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 子路由</span></span><br><span class="line">    <span class="keyword">if</span> (mainNormalizedRecord.children) {</span><br><span class="line">      <span class="keyword">const</span> children = mainNormalizedRecord.children</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.length; i++) {</span><br><span class="line">        addRoute(</span><br><span class="line">          children[i],</span><br><span class="line">          matcher,</span><br><span class="line">          originalRecord &amp;&amp; originalRecord.children[i]</span><br><span class="line">        )</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if there was no original record, then the first one was not an alias and all</span></span><br><span class="line">    <span class="comment">// other aliases (if any) need to reference this record when adding children</span></span><br><span class="line">    originalRecord = originalRecord || matcher</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> add normalized records for more flexibility</span></span><br><span class="line">    <span class="comment">// if (parent &amp;&amp; isAliasRecord(originalRecord)) {</span></span><br><span class="line">    <span class="comment">//   parent.children.push(originalRecord)</span></span><br><span class="line">    <span class="comment">// }</span></span><br><span class="line">    <span class="comment">// 添加到matchers中</span></span><br><span class="line">    insertMatcher(matcher)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 返回 删除函数</span></span><br><span class="line">  <span class="keyword">return</span> originalMatcher</span><br><span class="line">    ? <span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// since other matchers are aliases, they should be removed by the original matcher</span></span><br><span class="line">        removeRoute(originalMatcher!)</span><br><span class="line">      }</span><br><span class="line">    : noop</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="normalizeRouteRecord-amp-amp-normalizeRecordProps"><a href="#normalizeRouteRecord-amp-amp-normalizeRecordProps" class="headerlink" title="normalizeRouteRecord &amp;&amp; normalizeRecordProps"></a>normalizeRouteRecord &amp;&amp; normalizeRecordProps</h5><p>规范路由 和 规范props</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> RouteRecordRaw =</span><br><span class="line">  | RouteRecordSingleView</span><br><span class="line">  | RouteRecordSingleViewWithChildren</span><br><span class="line">  | RouteRecordMultipleViews</span><br><span class="line">  | RouteRecordMultipleViewsWithChildren</span><br><span class="line">  | RouteRecordRedirect</span><br><span class="line"><span class="comment">// 这可以学习一下，这个联合类型的使用(因为是函数参数，可以称为类型约束)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Route Record defining one single component with the `component` option.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 保证你写了component 就不会写components</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RouteRecordSingleView <span class="keyword">extends</span> _RouteRecordBase {</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Component to display when the URL matches this route.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">component</span>: RawRouteComponent</span><br><span class="line">  components?: <span class="built_in">never</span></span><br><span class="line">  children?: <span class="built_in">never</span></span><br><span class="line">  redirect?: <span class="built_in">never</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Allow passing down params as props to the component rendered by `router-view`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  props?: _RouteRecordProps</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Normalizes a RouteRecordRaw. Creates a copy</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">record</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns </span>the normalized version</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeRouteRecord</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  record: RouteRecordRaw</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouteRecordNormalized</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    <span class="attr">path</span>: record.path,</span><br><span class="line">    <span class="attr">redirect</span>: record.redirect,</span><br><span class="line">    <span class="attr">name</span>: record.name,</span><br><span class="line">    <span class="attr">meta</span>: record.meta || {},</span><br><span class="line">    <span class="comment">// 表示这个record 是否是另一个记录的别名</span></span><br><span class="line">    <span class="attr">aliasOf</span>: <span class="literal">undefined</span>,</span><br><span class="line">    <span class="attr">beforeEnter</span>: record.beforeEnter,</span><br><span class="line">    <span class="attr">props</span>: normalizeRecordProps(record),</span><br><span class="line">    <span class="attr">children</span>: record.children || [],</span><br><span class="line">    <span class="attr">instances</span>: {},</span><br><span class="line">    <span class="attr">leaveGuards</span>: <span class="keyword">new</span> <span class="built_in">Set</span>(),</span><br><span class="line">    <span class="attr">updateGuards</span>: <span class="keyword">new</span> <span class="built_in">Set</span>(),</span><br><span class="line">    <span class="attr">enterCallbacks</span>: {},</span><br><span class="line">    <span class="attr">components</span>:</span><br><span class="line">      <span class="string">'components'</span> <span class="keyword">in</span> record</span><br><span class="line">        ? record.components || <span class="literal">null</span></span><br><span class="line">        : record.component &amp;&amp; { <span class="attr">default</span>: record.component },</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Normalize the optional `props` in a record to always be an object similar to</span></span><br><span class="line"><span class="comment"> * components. Also accept a boolean for components.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">record</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeRecordProps</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  record: RouteRecordRaw</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_RouteRecordProps</span>&gt; </span>{</span><br><span class="line">  <span class="keyword">const</span> propsObject = {} <span class="keyword">as</span> Record&lt;<span class="built_in">string</span>, _RouteRecordProps&gt;</span><br><span class="line">  <span class="comment">// props does not exist on redirect records, but we can set false directly</span></span><br><span class="line">  <span class="keyword">const</span> props = record.props || <span class="literal">false</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'component'</span> <span class="keyword">in</span> record) {</span><br><span class="line">  <span class="comment">// 单一视图 默认就是default 的router-view</span></span><br><span class="line">    propsObject.default = props</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> we could also allow a function to be applied to every component.</span></span><br><span class="line">    <span class="comment">// Would need user feedback for use cases</span></span><br><span class="line">    <span class="comment">// 多视图， props就一一对应</span></span><br><span class="line">    <span class="comment">// https://router.vuejs.org/zh/api/#props </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">in</span> record.components)</span><br><span class="line">      propsObject[name] = <span class="keyword">typeof</span> props === <span class="string">'boolean'</span> ? props : props[name]</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> propsObject</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="createRouteRecordMatcher"><a href="#createRouteRecordMatcher" class="headerlink" title="createRouteRecordMatcher"></a>createRouteRecordMatcher</h5><p>创建路由匹配器</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> PathParser {</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The regexp used to match a url</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">re</span>: <span class="built_in">RegExp</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The score of the parser</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">score</span>: <span class="built_in">Array</span>&lt;<span class="built_in">number</span>[]&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Keys that appeared in the path</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  keys: PathParserParamKey[]</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Parses a url and returns the matched params or null if it doesn't match. An</span></span><br><span class="line"><span class="comment">   * optional param that isn't preset will be an empty string. A repeatable</span></span><br><span class="line"><span class="comment">   * param will be an array if there is at least one value.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">path</span></span> - url to parse</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns </span>a Params object, empty if there are no params. `null` if there is</span></span><br><span class="line"><span class="comment">   * no match</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  parse(path: <span class="built_in">string</span>): PathParams | <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a string version of the url</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">params</span></span> - object of params</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns </span>a url</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  stringify(params: PathParams): <span class="built_in">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouteRecordMatcher</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  record: Readonly&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  parent: RouteRecordMatcher | <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  options?: PathParserOptions</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouteRecordMatcher</span> </span>{</span><br><span class="line">    <span class="comment">// tokenizePath 就是将path转变成对象数组</span></span><br><span class="line">    <span class="comment">// 比如/user会转换为[[{type: 0, value: 'user'}]],</span></span><br><span class="line">    <span class="comment">// /user/:id则会转换成：[</span></span><br><span class="line">    <span class="comment">// [{type: 0, value: "user"}],</span></span><br><span class="line">    <span class="comment">//[{type: 1, value: "id", regexp: "", repeatable: false, optional: false}],</span></span><br><span class="line">   <span class="comment">// ]</span></span><br><span class="line">   <span class="comment">// PathParser</span></span><br><span class="line">  <span class="keyword">const</span> parser = tokensToParser(tokenizePath(record.path), options)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// warn against params with the same name</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) {</span><br><span class="line">    <span class="keyword">const</span> existingKeys = <span class="keyword">new</span> <span class="built_in">Set</span>&lt;<span class="built_in">string</span>&gt;()</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> parser.keys) {</span><br><span class="line">      <span class="keyword">if</span> (existingKeys.has(key.name))</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Found duplicated params with name "<span class="subst">${key.name}</span>" for path "<span class="subst">${record.path}</span>". Only the last one will be available on "$route.params".`</span></span><br><span class="line">        )</span><br><span class="line">      existingKeys.add(key.name)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 整合</span></span><br><span class="line">  <span class="keyword">const</span> matcher: RouteRecordMatcher = assign(parser, {</span><br><span class="line">    record,</span><br><span class="line">    parent,</span><br><span class="line">    <span class="comment">// these needs to be populated by the parent</span></span><br><span class="line">    <span class="attr">children</span>: [],</span><br><span class="line">    <span class="attr">alias</span>: [],</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (parent) {</span><br><span class="line">    <span class="comment">// both are aliases or both are not aliases</span></span><br><span class="line">    <span class="comment">// we don't want to mix them because the order is used when</span></span><br><span class="line">    <span class="comment">// passing originalRecord in Matcher.addRoute</span></span><br><span class="line">    <span class="keyword">if</span> (!matcher.record.aliasOf === !parent.record.aliasOf)</span><br><span class="line">      parent.children.push(matcher)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> matcher</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>tokensToParser</strong><br>将path 转换成 正则，分数（rank）</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">tokensToParser</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  segments: <span class="built_in">Array</span>&lt;Token[]&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  extraOptions?: _PathParserOptions</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">PathParser</span> </span>{</span><br><span class="line">  <span class="keyword">const</span> options = assign({}, BASE_PATH_PARSER_OPTIONS, extraOptions)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the amount of scores is the same as the length of segments except for the root segment "/"</span></span><br><span class="line">  <span class="comment">// 给每一个token 一个分数</span></span><br><span class="line">  <span class="keyword">const</span> score: <span class="built_in">Array</span>&lt;<span class="built_in">number</span>[]&gt; = []</span><br><span class="line">  <span class="comment">// the regexp as a string</span></span><br><span class="line">  <span class="keyword">let</span> pattern = options.start ? <span class="string">'^'</span> : <span class="string">''</span></span><br><span class="line">  <span class="comment">// extracted keys</span></span><br><span class="line">  <span class="comment">// 路由中的动态参数</span></span><br><span class="line">  <span class="keyword">const</span> keys: PathParserParamKey[] = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> segment <span class="keyword">of</span> segments) {</span><br><span class="line">    <span class="comment">// the root segment needs special treatment</span></span><br><span class="line">    <span class="keyword">const</span> segmentScores: <span class="built_in">number</span>[] = segment.length ? [] : [PathScore.Root]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow trailing slash</span></span><br><span class="line">    <span class="keyword">if</span> (options.strict &amp;&amp; !segment.length) pattern += <span class="string">'/'</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> tokenIndex = <span class="number">0</span>; tokenIndex &lt; segment.length; tokenIndex++) {</span><br><span class="line">      <span class="keyword">const</span> token = segment[tokenIndex]</span><br><span class="line">      <span class="comment">// resets the score if we are inside a sub-segment /:a-other-:b</span></span><br><span class="line">      <span class="keyword">let</span> subSegmentScore: <span class="built_in">number</span> =</span><br><span class="line">        PathScore.Segment +</span><br><span class="line">        (options.sensitive ? PathScore.BonusCaseSensitive : <span class="number">0</span>)</span><br><span class="line">      <span class="comment">// 静态路由 /home 这种</span></span><br><span class="line">      <span class="keyword">if</span> (token.type === TokenType.Static) {</span><br><span class="line">        <span class="comment">// prepend the slash if we are starting a new segment</span></span><br><span class="line">        <span class="comment">// 正则的斜杠</span></span><br><span class="line">        <span class="keyword">if</span> (!tokenIndex) pattern += <span class="string">'/'</span></span><br><span class="line">        pattern += token.value.replace(REGEX_CHARS_RE, <span class="string">'\\$&amp;'</span>)</span><br><span class="line">        subSegmentScore += PathScore.Static</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span> (token.type === TokenType.Param) {</span><br><span class="line">        <span class="keyword">const</span> { value, repeatable, optional, regexp } = token</span><br><span class="line">        keys.push({</span><br><span class="line">          <span class="attr">name</span>: value,</span><br><span class="line">          repeatable,</span><br><span class="line">          optional,</span><br><span class="line">        })</span><br><span class="line">        <span class="keyword">const</span> re = regexp ? regexp : BASE_PARAM_PATTERN</span><br><span class="line">        <span class="comment">// the user provided a custom regexp /:id(\\d+)</span></span><br><span class="line">        <span class="keyword">if</span> (re !== BASE_PARAM_PATTERN) {</span><br><span class="line">          subSegmentScore += PathScore.BonusCustomRegExp</span><br><span class="line">          <span class="comment">// make sure the regexp is valid before using it</span></span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`(<span class="subst">${re}</span>)`</span>)</span><br><span class="line">          } <span class="keyword">catch</span> (err) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">              <span class="string">`Invalid custom RegExp for param "<span class="subst">${value}</span>" (<span class="subst">${re}</span>): `</span> +</span><br><span class="line">                (err <span class="keyword">as</span> <span class="built_in">Error</span>).message</span><br><span class="line">            )</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// when we repeat we must take care of the repeating leading slash</span></span><br><span class="line">        <span class="keyword">let</span> subPattern = repeatable ? <span class="string">`((?:<span class="subst">${re}</span>)(?:/(?:<span class="subst">${re}</span>))*)`</span> : <span class="string">`(<span class="subst">${re}</span>)`</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// prepend the slash if we are starting a new segment</span></span><br><span class="line">        <span class="keyword">if</span> (!tokenIndex)</span><br><span class="line">          subPattern =</span><br><span class="line">            <span class="comment">// avoid an optional / if there are more segments e.g. /:p?-static</span></span><br><span class="line">            <span class="comment">// or /:p?-:p2</span></span><br><span class="line">            optional &amp;&amp; segment.length &lt; <span class="number">2</span></span><br><span class="line">              ? <span class="string">`(?:/<span class="subst">${subPattern}</span>)`</span></span><br><span class="line">              : <span class="string">'/'</span> + subPattern</span><br><span class="line">        <span class="keyword">if</span> (optional) subPattern += <span class="string">'?'</span></span><br><span class="line"></span><br><span class="line">        pattern += subPattern</span><br><span class="line"></span><br><span class="line">        subSegmentScore += PathScore.Dynamic</span><br><span class="line">        <span class="keyword">if</span> (optional) subSegmentScore += PathScore.BonusOptional</span><br><span class="line">        <span class="keyword">if</span> (repeatable) subSegmentScore += PathScore.BonusRepeatable</span><br><span class="line">        <span class="keyword">if</span> (re === <span class="string">'.*'</span>) subSegmentScore += PathScore.BonusWildcard</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      segmentScores.push(subSegmentScore)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// an empty array like /home/ -&gt; [[{home}], []]</span></span><br><span class="line">    <span class="comment">// if (!segment.length) pattern += '/'</span></span><br><span class="line"></span><br><span class="line">    score.push(segmentScores)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// only apply the strict bonus to the last score</span></span><br><span class="line">  <span class="comment">// 最后一位 奖励 0.7分</span></span><br><span class="line">  <span class="keyword">if</span> (options.strict &amp;&amp; options.end) {</span><br><span class="line">    <span class="keyword">const</span> i = score.length - <span class="number">1</span></span><br><span class="line">    score[i][score[i].length - <span class="number">1</span>] += PathScore.BonusStrict</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> dev only warn double trailing slash</span></span><br><span class="line">  <span class="keyword">if</span> (!options.strict) pattern += <span class="string">'/?'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.end) pattern += <span class="string">'$'</span></span><br><span class="line">  <span class="comment">// allow paths like /dynamic to only match dynamic or dynamic/... but not dynamic_something_else</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (options.strict) pattern += <span class="string">'(?:/|$)'</span></span><br><span class="line">  <span class="comment">// home =&gt; "^\\/home$"</span></span><br><span class="line">  <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(pattern, options.sensitive ? <span class="string">''</span> : <span class="string">'i'</span>)</span><br><span class="line">  <span class="comment">// 传入path参数，然后根据re，然后遍历得到的结果，获取动态参数对象。</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params">path: <span class="built_in">string</span></span>): <span class="title">PathParams</span> | <span class="title">null</span> </span>{</span><br><span class="line">    <span class="keyword">const</span> match = path.match(re)</span><br><span class="line">    <span class="keyword">const</span> params: PathParams = {}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!match) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; match.length; i++) {</span><br><span class="line">      <span class="keyword">const</span> value: <span class="built_in">string</span> = match[i] || <span class="string">''</span></span><br><span class="line">      <span class="keyword">const</span> key = keys[i - <span class="number">1</span>]</span><br><span class="line">      params[key.name] = value &amp;&amp; key.repeatable ? value.split(<span class="string">'/'</span>) : value</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> params</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 该方法传入params对象，然后返回参数对象结合path组成的替换了参数值的path</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">stringify</span>(<span class="params">params: PathParams</span>): <span class="title">string</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">''</span></span><br><span class="line">    <span class="comment">// for optional parameters to allow to be empty</span></span><br><span class="line">    <span class="keyword">let</span> avoidDuplicatedSlash: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> segment <span class="keyword">of</span> segments) {</span><br><span class="line">      <span class="keyword">if</span> (!avoidDuplicatedSlash || !path.endsWith(<span class="string">'/'</span>)) path += <span class="string">'/'</span></span><br><span class="line">      avoidDuplicatedSlash = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> token <span class="keyword">of</span> segment) {</span><br><span class="line">        <span class="keyword">if</span> (token.type === TokenType.Static) {</span><br><span class="line">          path += token.value</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (token.type === TokenType.Param) {</span><br><span class="line">          <span class="keyword">const</span> { value, repeatable, optional } = token</span><br><span class="line">          <span class="keyword">const</span> param: <span class="built_in">string</span> | <span class="keyword">readonly</span> <span class="built_in">string</span>[] =</span><br><span class="line">            value <span class="keyword">in</span> params ? params[value] : <span class="string">''</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (isArray(param) &amp;&amp; !repeatable) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">              <span class="string">`Provided param "<span class="subst">${value}</span>" is an array but it is not repeatable (* or + modifiers)`</span></span><br><span class="line">            )</span><br><span class="line">          }</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> text: <span class="built_in">string</span> = isArray(param)</span><br><span class="line">            ? (param <span class="keyword">as</span> <span class="built_in">string</span>[]).join(<span class="string">'/'</span>)</span><br><span class="line">            : (param <span class="keyword">as</span> <span class="built_in">string</span>)</span><br><span class="line">          <span class="keyword">if</span> (!text) {</span><br><span class="line">            <span class="keyword">if</span> (optional) {</span><br><span class="line">              <span class="comment">// if we have more than one optional param like /:a?-static we don't need to care about the optional param</span></span><br><span class="line">              <span class="keyword">if</span> (segment.length &lt; <span class="number">2</span>) {</span><br><span class="line">                <span class="comment">// remove the last slash as we could be at the end</span></span><br><span class="line">                <span class="keyword">if</span> (path.endsWith(<span class="string">'/'</span>)) path = path.slice(<span class="number">0</span>, -<span class="number">1</span>)</span><br><span class="line">                <span class="comment">// do not append a slash on the next iteration</span></span><br><span class="line">                <span class="keyword">else</span> avoidDuplicatedSlash = <span class="literal">true</span></span><br><span class="line">              }</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Missing required param "<span class="subst">${value}</span>"`</span>)</span><br><span class="line">          }</span><br><span class="line">          path += text</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// avoid empty path when we have multiple optional params</span></span><br><span class="line">    <span class="keyword">return</span> path || <span class="string">'/'</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    re,</span><br><span class="line">    score,</span><br><span class="line">    keys,</span><br><span class="line">    parse,</span><br><span class="line">    stringify,</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="insertMatchers"><a href="#insertMatchers" class="headerlink" title="insertMatchers"></a>insertMatchers</h4><p>将matcher 插入到matchers中</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertMatcher</span>(<span class="params">matcher: RouteRecordMatcher</span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 找到需要插入的下标</span></span><br><span class="line">  <span class="comment">// 因为score 是一个权重的数组，第一位相等就比较第二位。可以类比版本号</span></span><br><span class="line">  <span class="comment">// 从大到小排列</span></span><br><span class="line">  <span class="comment">// [[80.7]] [[80],[60]]</span></span><br><span class="line">  <span class="keyword">while</span> (</span><br><span class="line">    i &lt; matchers.length &amp;&amp;</span><br><span class="line">    comparePathParserScore(matcher, matchers[i]) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">    <span class="comment">// Adding children with empty path should still appear before the parent</span></span><br><span class="line">    <span class="comment">// https://github.com/vuejs/router/issues/1124</span></span><br><span class="line">    (matcher.record.path !== matchers[i].record.path ||</span><br><span class="line">      !isRecordChildOf(matcher, matchers[i]))</span><br><span class="line">  )</span><br><span class="line">    i++</span><br><span class="line">  <span class="comment">// 插入进去</span></span><br><span class="line">  matchers.splice(i, <span class="number">0</span>, matcher)</span><br><span class="line">  <span class="comment">// only add the original record to the name map</span></span><br><span class="line">  <span class="comment">// 有name的 还是源路由就添加到map 中</span></span><br><span class="line">  <span class="keyword">if</span> (matcher.record.name &amp;&amp; !isAliasRecord(matcher))</span><br><span class="line">    matcherMap.set(matcher.record.name, matcher)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="removeRoute"><a href="#removeRoute" class="headerlink" title="removeRoute"></a>removeRoute</h4><p>移除路由, 根据传入的name或者matcher对象，删除匹配器</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeRoute</span>(<span class="params">matcherRef: RouteRecordName | RouteRecordMatcher</span>) </span>{</span><br><span class="line">  <span class="keyword">if</span> (isRouteName(matcherRef)) {</span><br><span class="line">    <span class="keyword">const</span> matcher = matcherMap.get(matcherRef)</span><br><span class="line">    <span class="keyword">if</span> (matcher) {</span><br><span class="line">      matcherMap.delete(matcherRef)</span><br><span class="line">      matchers.splice(matchers.indexOf(matcher), <span class="number">1</span>)</span><br><span class="line">      <span class="comment">// 删除 子路由</span></span><br><span class="line">      matcher.children.forEach(removeRoute)</span><br><span class="line">      <span class="comment">// 删除 别名路由</span></span><br><span class="line">      matcher.alias.forEach(removeRoute)</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">const</span> index = matchers.indexOf(matcherRef)</span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) {</span><br><span class="line">      matchers.splice(index, <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">if</span> (matcherRef.record.name) matcherMap.delete(matcherRef.record.name)</span><br><span class="line">      matcherRef.children.forEach(removeRoute)</span><br><span class="line">      matcherRef.alias.forEach(removeRoute)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve</h4><p>resolve方法返回MatcherLocation对象，该对象包含的属性为：name、path、params、matched、meta，作用就是根据传入的location进行路由匹配，找到location对应的matcher对应的路由信息。</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  location: Readonly&lt;MatcherLocationRaw&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  currentLocation: Readonly&lt;MatcherLocation&gt;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">MatcherLocation</span> </span>{</span><br><span class="line">  <span class="keyword">let</span> matcher: RouteRecordMatcher | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">let</span> params: PathParams = {}</span><br><span class="line">  <span class="keyword">let</span> path: MatcherLocation[<span class="string">'path'</span>]</span><br><span class="line">  <span class="keyword">let</span> name: MatcherLocation[<span class="string">'name'</span>]</span><br><span class="line">  <span class="comment">// 带有name key 那么 location 就是 MatcherLocationAsName </span></span><br><span class="line">  <span class="comment">//{</span></span><br><span class="line">  <span class="comment">//  name: RouteRecordName</span></span><br><span class="line">  <span class="comment">//  params?: RouteParams</span></span><br><span class="line">  <span class="comment">// }</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'name'</span> <span class="keyword">in</span> location &amp;&amp; location.name) {</span><br><span class="line">    matcher = matcherMap.get(location.name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!matcher)</span><br><span class="line">      <span class="keyword">throw</span> createRouterError&lt;MatcherError&gt;(ErrorTypes.MATCHER_NOT_FOUND, {</span><br><span class="line">        location,</span><br><span class="line">      })</span><br><span class="line"></span><br><span class="line">    <span class="comment">// warn if the user is passing invalid params so they can debug it better when they get removed</span></span><br><span class="line">    <span class="comment">// 警告用户是否传递了无效的参数，以便他们在被删除时可以更好地调试它</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) {</span><br><span class="line">      <span class="comment">// !. 是ts的非空断言符，表示matcher一定不是null 和 undefined</span></span><br><span class="line">      <span class="keyword">const</span> invalidParams: <span class="built_in">string</span>[] = <span class="built_in">Object</span>.keys(</span><br><span class="line">        location.params || {} <span class="comment">// matcher.keys 是 路由的动态参数</span></span><br><span class="line">      ).filter(<span class="function"><span class="params">paramName</span> =&gt;</span> !matcher!.keys.find(<span class="function"><span class="params">k</span> =&gt;</span> k.name === paramName))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (invalidParams.length) {</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Discarded invalid param(s) "<span class="subst">${invalidParams.join(</span></span></span><br><span class="line"><span class="subst"><span class="string">            <span class="string">'", "'</span></span></span></span><br><span class="line"><span class="subst"><span class="string">          )}</span>" when navigating. See https://github.com/vuejs/router/blob/main/packages/router/CHANGELOG.md#414-2022-08-22 for more details.`</span></span><br><span class="line">        )</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    name = matcher.record.name</span><br><span class="line">    <span class="comment">// 参数合并</span></span><br><span class="line">    params = assign(</span><br><span class="line">      <span class="comment">// paramsFromLocation is a new object</span></span><br><span class="line">      paramsFromLocation(</span><br><span class="line">        currentLocation.params,</span><br><span class="line">        <span class="comment">// only keep params that exist in the resolved location</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> only keep optional params coming from a parent record</span></span><br><span class="line">        matcher.keys.filter(<span class="function"><span class="params">k</span> =&gt;</span> !k.optional).map(<span class="function"><span class="params">k</span> =&gt;</span> k.name)</span><br><span class="line">      ),</span><br><span class="line">      <span class="comment">// discard any existing params in the current location that do not exist here</span></span><br><span class="line">      <span class="comment">// #1497 this ensures better active/exact matching</span></span><br><span class="line">      location.params &amp;&amp;</span><br><span class="line">        paramsFromLocation(</span><br><span class="line">          location.params,</span><br><span class="line">          matcher.keys.map(<span class="function"><span class="params">k</span> =&gt;</span> k.name)</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// throws if cannot be stringified</span></span><br><span class="line">    <span class="comment">// 解析成完整的 path  /user/:id =&gt; /user/2</span></span><br><span class="line">    path = matcher.stringify(params)</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'path'</span> <span class="keyword">in</span> location) {</span><br><span class="line">    <span class="comment">// no need to resolve the path with the matcher as it was provided</span></span><br><span class="line">    <span class="comment">// this also allows the user to control the encoding</span></span><br><span class="line">    path = location.path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !path.startsWith(<span class="string">'/'</span>)) {</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`The Matcher cannot resolve relative paths but received "<span class="subst">${path}</span>". Unless you directly called \`matcher.resolve("<span class="subst">${path}</span>")\`, this is probably a bug in vue-router. Please open an issue at https://new-issue.vuejs.org/?repo=vuejs/router.`</span></span><br><span class="line">      )</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 符合要求的匹配器</span></span><br><span class="line">    matcher = matchers.find(<span class="function"><span class="params">m</span> =&gt;</span> m.re.test(path))</span><br><span class="line">    <span class="comment">// matcher should have a value after the loop</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (matcher) {</span><br><span class="line">      <span class="comment">// we know the matcher works because we tested the regexp</span></span><br><span class="line">      params = matcher.parse(path)!</span><br><span class="line">      name = matcher.record.name</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// location is a relative path</span></span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// match by name or path of current route</span></span><br><span class="line">    matcher = currentLocation.name</span><br><span class="line">      ? matcherMap.get(currentLocation.name)</span><br><span class="line">      : matchers.find(<span class="function"><span class="params">m</span> =&gt;</span> m.re.test(currentLocation.path))</span><br><span class="line">    <span class="keyword">if</span> (!matcher)</span><br><span class="line">      <span class="keyword">throw</span> createRouterError&lt;MatcherError&gt;(ErrorTypes.MATCHER_NOT_FOUND, {</span><br><span class="line">        location,</span><br><span class="line">        currentLocation,</span><br><span class="line">      })</span><br><span class="line">    name = matcher.record.name</span><br><span class="line">    <span class="comment">// since we are navigating to the same location, we don't need to pick the</span></span><br><span class="line">    <span class="comment">// params like when `name` is provided</span></span><br><span class="line">    params = assign({}, currentLocation.params, location.params)</span><br><span class="line">    path = matcher.stringify(params)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> matched: MatcherLocation[<span class="string">'matched'</span>] = []</span><br><span class="line">  <span class="keyword">let</span> parentMatcher: RouteRecordMatcher | <span class="literal">undefined</span> = matcher</span><br><span class="line">  <span class="keyword">while</span> (parentMatcher) {</span><br><span class="line">    <span class="comment">// reversed order so parents are at the beginning</span></span><br><span class="line"></span><br><span class="line">    matched.unshift(parentMatcher.record)</span><br><span class="line">    parentMatcher = parentMatcher.parent</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    name,</span><br><span class="line">    path,</span><br><span class="line">    params,</span><br><span class="line">    <span class="comment">// 匹配到的匹配器，能同个record 的正则匹配</span></span><br><span class="line">    matched,</span><br><span class="line">    <span class="attr">meta</span>: mergeMetaFields(matched),</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></body></html>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/vue-router/" rel="tag"># vue-router</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/10/16/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E4%BA%8C)/" rel="prev" title="vue-router源码解读(二)">
                  <i class="fa fa-chevron-left"></i> vue-router源码解读(二)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/11/07/vue-router%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB(%E5%9B%9B)/" rel="next" title="vue-router源码解读(四)">
                  vue-router源码解读(四) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">灰沙</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/haru01.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":1},"log":false});</script></body>
</html>
